<!DOCTYPE html>
<html>
  <head>
    <title>UNSW Cognition Lab</title>

    <script src="./js/jquery.min.js"></script>
    <script src="./js/jspsych.js"></script>
    <script src="./js/seedrandom.min.js"></script>
    <script src="./js/plugins/jspsych-demographic-response.js"></script>
    <script src="./js/plugins/jspsych-fullscreen.js"></script>
    <script src="./js/plugins/jspsych-html-button-response.js"></script>
    <script src="./js/plugins/jspsych-visual-search-gabor.js"></script>
    <script src="./js/plugins/jspsych-dm-gabor.js"></script>
    <script src="./js/plugins/jspsych-html-keyboard-response-mlp.js"></script>
    <script src="./js/plugins/jspsych-instructions.js"></script>
    <script src="./js/plugins/jspsych-survey-multi-choice-mlp.js"></script>
    <script src="./js/plugins/jspsych-survey-text-mlp.js"></script>
    <script src="./js/plugins/jspsych-preload.js"></script>
    <script src="./js/helper.js"></script>
    <script src="jatos.js"></script>

    <link href="./js/css/jspsych.css" rel="stylesheet" type="text/css" />

    <style>
      .fancyButtonRed {
        display: inline-block;
        padding: 15px 15px;
        font-size: 24px;
        cursor: pointer;
        text-align: center;
        text-decoration: none;
        outline: none;
        color: #fff;
        background-color: #af504c;
        border: none;
        box-shadow: 0 9px #999;
      }
      .fancyButtonRed:hover {
        background-color: #8e413e;
      }
      .fancyButtonRed:active {
        background-color: #8e413e;
        box-shadow: 0 5px #666;
        transform: translateY(4px);
      }

      .endTestButton {
        display: inline-block;
        padding: 5px 5px;
        font-size: 110%;
        cursor: pointer;
        text-align: center;
        text-decoration: none;
        outline: none;
        color: #fff;
        background-color: #505050;
        border: 4px solid black;
      }
      .endTestButton:hover {
        background-color: #8e413e;
      }

      .choiceTestButton {
        padding: 0px 0px;
        width: 200px;
        height: 200px;
        cursor: grab;
        text-align: center;
        outline: none;
        color: #fff;
        background-color: #000000;
        border: 2px solid #808080;
      }
      .choiceTestButton:hover {
        border: 2px solid white;
      }

      .consentButton {
        display: inline-block;
        padding: 6px 12px;
        margin: 0px;
        font-size: 14px;
        font-weight: 400;
        font-family: "Open Sans", "Arial", sans-serif;
        cursor: pointer;
        line-height: 1.4;
        text-align: center;
        white-space: nowrap;
        vertical-align: middle;
        background-image: none;
        border: 1px solid transparent;
        border-radius: 4px;
        color: #333;
        background-color: #b8e9ac;
        border: 2px solid black;
      }
      .consentButton:hover {
        background-color: #81b474;
      }

      .noConsentButton {
        display: inline-block;
        padding: 6px 12px;
        margin: 0px;
        font-size: 14px;
        font-weight: 400;
        font-family: "Open Sans", "Arial", sans-serif;
        cursor: pointer;
        line-height: 1.4;
        text-align: center;
        white-space: nowrap;
        vertical-align: middle;
        background-image: none;
        border: 1px solid transparent;
        border-radius: 4px;
        color: #333;
        background-color: #f09c9c;
        border: 2px solid black;
      }
      .noConsentButton:hover {
        background-color: #cc8585;
      }

      .conDets {
        font-size: 90%;
        line-height: 120%;
      }

      .row {
        display: flex;
      }

      .column {
        flex: 33.33%;
        padding: 5px;
      }

      /* Chrome, Safari, Edge, Opera */
      input::-webkit-outer-spin-button,
      input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }

      /* Firefox */
      input[type="number"] {
        -moz-appearance: textfield;
      }

      #jspsychTargetMLP {
        text-align: center;
        position: absolute;
        top: 0%;
        left: 50%;
        margin-top: 0;
        margin-left: -400px;
        height: 100%;
        width: 800px;
        overflow-y: auto;
        overflow-x: auto;
        font-family: "Segoe UI", Arial, sans-serif;
        font-size: 110%;
        color: black;
      }

      body {
        background-color: white;
      }

      html,
      body {
        margin: 0;
        height: 100%;
        width: 100%;
      }
    </style>
  </head>

  <body>
    <div id="jspsychTargetMLP"></div>
  </body>
  <script>
    // var lightnessVal = 0;

    document.body.style.backgroundColor = "hsl(0,0%," + lightnessVal + "%)";

    var realVersion = true;
    var jatosVersion = true;
    var sonaVersion = true;
    var prolificVersion = false;

    var exptPhase = 0; // 0 = practice, 1 = main task
    var epoch = 0;
    var instSet = 0;

    var goodBlockScore = 6400;

    Math.seedrandom();
    rSeed = Math.floor(Math.random() * 9999999);
    Math.seedrandom(rSeed);

    console.log("e1_vmacdm");
    console.log("realVersion: " + realVersion);
    console.log("jatosVersion: " + jatosVersion);
    console.log("sonaVersion:" + sonaVersion);
    console.log("prolificVersion:" + prolificVersion);

    // ******************* IMPORTANT PARAMETERS ******************
    var numStimLocs = 6;
    var colBalance; // 0 = orange high, 2  = blue high
    var dmBalance;
    // 0 = Value: Spatial Frequency (Dir 1), Probability: Oreintation (Dir 1)
    // 1 = Value: Spatial Frequency (Dir 2), Probability: Orientation (Dir 1)
    // 2 = Value: Spatial Frequency (Dir 1), Probability: Orientation (Dir 2)
    // 3 = Value: Spatial Frequency (Dir 2), Probability: Oreintation (Dir 2)

    var sona_id = 0;
    var prolific_id = 0;
    var batch_id = 0;
    var resultsID = 0;

    var prizeStr = "a $15 Coles/Woolworths Voucher";
    var prizeStrShort = "a $15 Voucher";

    // If these values aren't set, assign them randomly
    var validColBalance = [0, 1];
    if (!validColBalance.includes(colBalance)) {
      colBalance = Math.floor(Math.random() * 2);
    }

    // If these values aren't set, assign them randomly
    var validDMBalance = [0, 1, 2, 3];
    if (!validDMBalance.includes(dmBalance)) {
      dmBalance = Math.floor(Math.random() * 4);
    }

    jsPsych.data.addProperties({
      sub_num: sona_id,
      col_balance: colBalance,
      dm_balance: dmBalance,
      resultsID: resultsID,
    });

    var fieldsToIgnore = [
      "internal_node_id",
      "stimulus",
      "view_history",
      "question_order",
      "success",
      "failed_images",
      "failed_audio",
      "failed_video",
      "timeout",
    ];

    var winWidth = 800;

    var searchStrBase = "./img2/search/search_c";
    var distractStr = [];
    var colourName = [];
    switch (colBalance) {
      case 0:
        distractStr[0] = searchStrBase + "1_a";
        distractStr[1] = searchStrBase + "2_a";
        colourName[0] = "orange";
        colourName[1] = "blue";
        break;
      case 1:
        distractStr[0] = searchStrBase + "2_a";
        distractStr[1] = searchStrBase + "1_a";
        colourName[0] = "blue";
        colourName[1] = "orange";
        break;
    }

    distractStr[2] = searchStrBase + "3_a";
    distractStr[3] = searchStrBase + "4_a";

    var searchTargetStr = "./img2/search/search_target_c3_a";

    var dmStrBase = "./img2/decide/decide_c";
    var dmStimStrBase = [];
    switch (colBalance) {
      case 0:
        dmStimStrBase[0] = dmStrBase + "1_a";
        dmStimStrBase[1] = dmStrBase + "2_a";
        break;
      case 1:
        dmStimStrBase[0] = dmStrBase + "2_a";
        dmStimStrBase[1] = dmStrBase + "1_a";
        break;
    }

    dmStimStrBase[2] = dmStrBase + "3_a";
    dmStimStrBase[3] = dmStrBase + "4_a";

    var dmPlaceholderStr = "./img2/decide/decide_placeholder.png";

    var targExFilename1 = "./img2/examples/search_example.PNG";

    var colourExImage = [];
    if (colBalance == 0) {
      colourExImage[0] = "./img2/examples/search_example_orange.PNG";
      colourExImage[1] = "./img2/examples/search_example_blue.png";
    } else {
      colourExImage[0] = "./img2/examples/search_example_blue.PNG";
      colourExImage[1] = "./img2/examples/search_example_orange.png";
    }

    var aOrAn = [];
    for (ii = 0; ii < distractStr.length; ii++) {
      if (distractStr[ii] == searchStrBase + "1_a") {
        aOrAn[ii] = "an ";
      } else {
        aOrAn[ii] = "a ";
      }
    }

    var medalDisplayFilename = "./img2/medals/MedalDisplay.jpg";
    var numMedals = 6;
    var medalImgStr = [];
    for (ii = 0; ii < numMedals; ii++) {
      medalImgStr[ii] = "./img2/medals/medal" + ii + ".png";
    }

    var trialTargetOrient;
    var trialTargetLoc;

    var imageFilenames = [
      colourExImage,
      targExFilename1,
      "./img2/search/fixationCross.png",
      "./img2/search/search_c1_a1.png",
      "./img2/search/search_c1_a2.png",
      "./img2/search/search_c2_a1.png",
      "./img2/search/search_c2_a2.png",
      "./img2/search/search_c3_a1.png",
      "./img2/search/search_c3_a2.png",
      "./img2/search/search_c4_a1.png",
      "./img2/search/search_c4_a2.png",
      "./img2/search/search_target_c3_a1.png",
      "./img2/search/search_target_c3_a2.png",
      "./img2/decide/decide_c1_a1_sf1.png",
      "./img2/decide/decide_c1_a1_sf2.png",
      "./img2/decide/decide_c1_a1_sf3.png",
      "./img2/decide/decide_c1_a1_sf4.png",
      "./img2/decide/decide_c1_a1_sf5.png",
      "./img2/decide/decide_c1_a1_sf6.png",
      "./img2/decide/decide_c1_a1_sf7.png",
      "./img2/decide/decide_c1_a1_sf8.png",
      "./img2/decide/decide_c2_a1_sf1.png",
      "./img2/decide/decide_c2_a1_sf2.png",
      "./img2/decide/decide_c2_a1_sf3.png",
      "./img2/decide/decide_c2_a1_sf4.png",
      "./img2/decide/decide_c2_a1_sf5.png",
      "./img2/decide/decide_c2_a1_sf6.png",
      "./img2/decide/decide_c2_a1_sf7.png",
      "./img2/decide/decide_c2_a1_sf8.png",
      "./img2/decide/decide_c3_a1_sf1.png",
      "./img2/decide/decide_c3_a1_sf2.png",
      "./img2/decide/decide_c3_a1_sf3.png",
      "./img2/decide/decide_c3_a1_sf4.png",
      "./img2/decide/decide_c3_a1_sf5.png",
      "./img2/decide/decide_c3_a1_sf6.png",
      "./img2/decide/decide_c3_a1_sf7.png",
      "./img2/decide/decide_c3_a1_sf8.png",
      "./img2/decide/decide_c1_a2_sf1.png",
      "./img2/decide/decide_c1_a2_sf2.png",
      "./img2/decide/decide_c1_a2_sf3.png",
      "./img2/decide/decide_c1_a2_sf4.png",
      "./img2/decide/decide_c1_a2_sf5.png",
      "./img2/decide/decide_c1_a2_sf6.png",
      "./img2/decide/decide_c1_a2_sf7.png",
      "./img2/decide/decide_c1_a2_sf8.png",
      "./img2/decide/decide_c2_a2_sf1.png",
      "./img2/decide/decide_c2_a2_sf2.png",
      "./img2/decide/decide_c2_a2_sf3.png",
      "./img2/decide/decide_c2_a2_sf4.png",
      "./img2/decide/decide_c2_a2_sf5.png",
      "./img2/decide/decide_c2_a2_sf6.png",
      "./img2/decide/decide_c2_a2_sf7.png",
      "./img2/decide/decide_c2_a2_sf8.png",
      "./img2/decide/decide_c3_a2_sf1.png",
      "./img2/decide/decide_c3_a2_sf2.png",
      "./img2/decide/decide_c3_a2_sf3.png",
      "./img2/decide/decide_c3_a2_sf4.png",
      "./img2/decide/decide_c3_a2_sf5.png",
      "./img2/decide/decide_c3_a2_sf6.png",
      "./img2/decide/decide_c3_a2_sf7.png",
      "./img2/decide/decide_c3_a2_sf8.png",
      "./img2/decide/decide_c1_a3_sf1.png",
      "./img2/decide/decide_c1_a3_sf2.png",
      "./img2/decide/decide_c1_a3_sf3.png",
      "./img2/decide/decide_c1_a3_sf4.png",
      "./img2/decide/decide_c1_a3_sf5.png",
      "./img2/decide/decide_c1_a3_sf6.png",
      "./img2/decide/decide_c1_a3_sf7.png",
      "./img2/decide/decide_c1_a3_sf8.png",
      "./img2/decide/decide_c2_a3_sf1.png",
      "./img2/decide/decide_c2_a3_sf2.png",
      "./img2/decide/decide_c2_a3_sf3.png",
      "./img2/decide/decide_c2_a3_sf4.png",
      "./img2/decide/decide_c2_a3_sf5.png",
      "./img2/decide/decide_c2_a3_sf6.png",
      "./img2/decide/decide_c2_a3_sf7.png",
      "./img2/decide/decide_c2_a3_sf8.png",
      "./img2/decide/decide_c3_a3_sf1.png",
      "./img2/decide/decide_c3_a3_sf2.png",
      "./img2/decide/decide_c3_a3_sf3.png",
      "./img2/decide/decide_c3_a3_sf4.png",
      "./img2/decide/decide_c3_a3_sf5.png",
      "./img2/decide/decide_c3_a3_sf6.png",
      "./img2/decide/decide_c3_a3_sf7.png",
      "./img2/decide/decide_c3_a3_sf8.png",
      "./img2/decide/decide_c1_a4_sf1.png",
      "./img2/decide/decide_c1_a4_sf2.png",
      "./img2/decide/decide_c1_a4_sf3.png",
      "./img2/decide/decide_c1_a4_sf4.png",
      "./img2/decide/decide_c1_a4_sf5.png",
      "./img2/decide/decide_c1_a4_sf6.png",
      "./img2/decide/decide_c1_a4_sf7.png",
      "./img2/decide/decide_c1_a4_sf8.png",
      "./img2/decide/decide_c2_a4_sf1.png",
      "./img2/decide/decide_c2_a4_sf2.png",
      "./img2/decide/decide_c2_a4_sf3.png",
      "./img2/decide/decide_c2_a4_sf4.png",
      "./img2/decide/decide_c2_a4_sf5.png",
      "./img2/decide/decide_c2_a4_sf6.png",
      "./img2/decide/decide_c2_a4_sf7.png",
      "./img2/decide/decide_c2_a4_sf8.png",
      "./img2/decide/decide_c3_a4_sf1.png",
      "./img2/decide/decide_c3_a4_sf2.png",
      "./img2/decide/decide_c3_a4_sf3.png",
      "./img2/decide/decide_c3_a4_sf4.png",
      "./img2/decide/decide_c3_a4_sf5.png",
      "./img2/decide/decide_c3_a4_sf6.png",
      "./img2/decide/decide_c3_a4_sf7.png",
      "./img2/decide/decide_c3_a4_sf8.png",
      "./img2/decide/decide_c1_a5_sf1.png",
      "./img2/decide/decide_c1_a5_sf2.png",
      "./img2/decide/decide_c1_a5_sf3.png",
      "./img2/decide/decide_c1_a5_sf4.png",
      "./img2/decide/decide_c1_a5_sf5.png",
      "./img2/decide/decide_c1_a5_sf6.png",
      "./img2/decide/decide_c1_a5_sf7.png",
      "./img2/decide/decide_c1_a5_sf8.png",
      "./img2/decide/decide_c2_a5_sf1.png",
      "./img2/decide/decide_c2_a5_sf2.png",
      "./img2/decide/decide_c2_a5_sf3.png",
      "./img2/decide/decide_c2_a5_sf4.png",
      "./img2/decide/decide_c2_a5_sf5.png",
      "./img2/decide/decide_c2_a5_sf6.png",
      "./img2/decide/decide_c2_a5_sf7.png",
      "./img2/decide/decide_c2_a5_sf8.png",
      "./img2/decide/decide_c3_a5_sf1.png",
      "./img2/decide/decide_c3_a5_sf2.png",
      "./img2/decide/decide_c3_a5_sf3.png",
      "./img2/decide/decide_c3_a5_sf4.png",
      "./img2/decide/decide_c3_a5_sf5.png",
      "./img2/decide/decide_c3_a5_sf6.png",
      "./img2/decide/decide_c3_a5_sf7.png",
      "./img2/decide/decide_c3_a5_sf8.png",
      "./img2/decide/decide_c1_a6_sf1.png",
      "./img2/decide/decide_c1_a6_sf2.png",
      "./img2/decide/decide_c1_a6_sf3.png",
      "./img2/decide/decide_c1_a6_sf4.png",
      "./img2/decide/decide_c1_a6_sf5.png",
      "./img2/decide/decide_c1_a6_sf6.png",
      "./img2/decide/decide_c1_a6_sf7.png",
      "./img2/decide/decide_c1_a6_sf8.png",
      "./img2/decide/decide_c2_a6_sf1.png",
      "./img2/decide/decide_c2_a6_sf2.png",
      "./img2/decide/decide_c2_a6_sf3.png",
      "./img2/decide/decide_c2_a6_sf4.png",
      "./img2/decide/decide_c2_a6_sf5.png",
      "./img2/decide/decide_c2_a6_sf6.png",
      "./img2/decide/decide_c2_a6_sf7.png",
      "./img2/decide/decide_c2_a6_sf8.png",
      "./img2/decide/decide_c3_a6_sf1.png",
      "./img2/decide/decide_c3_a6_sf2.png",
      "./img2/decide/decide_c3_a6_sf3.png",
      "./img2/decide/decide_c3_a6_sf4.png",
      "./img2/decide/decide_c3_a6_sf5.png",
      "./img2/decide/decide_c3_a6_sf6.png",
      "./img2/decide/decide_c3_a6_sf7.png",
      "./img2/decide/decide_c3_a6_sf8.png",
      "./img2/decide/decide_c1_a7_sf1.png",
      "./img2/decide/decide_c1_a7_sf2.png",
      "./img2/decide/decide_c1_a7_sf3.png",
      "./img2/decide/decide_c1_a7_sf4.png",
      "./img2/decide/decide_c1_a7_sf5.png",
      "./img2/decide/decide_c1_a7_sf6.png",
      "./img2/decide/decide_c1_a7_sf7.png",
      "./img2/decide/decide_c1_a7_sf8.png",
      "./img2/decide/decide_c2_a7_sf1.png",
      "./img2/decide/decide_c2_a7_sf2.png",
      "./img2/decide/decide_c2_a7_sf3.png",
      "./img2/decide/decide_c2_a7_sf4.png",
      "./img2/decide/decide_c2_a7_sf5.png",
      "./img2/decide/decide_c2_a7_sf6.png",
      "./img2/decide/decide_c2_a7_sf7.png",
      "./img2/decide/decide_c2_a7_sf8.png",
      "./img2/decide/decide_c3_a7_sf1.png",
      "./img2/decide/decide_c3_a7_sf2.png",
      "./img2/decide/decide_c3_a7_sf3.png",
      "./img2/decide/decide_c3_a7_sf4.png",
      "./img2/decide/decide_c3_a7_sf5.png",
      "./img2/decide/decide_c3_a7_sf6.png",
      "./img2/decide/decide_c3_a7_sf7.png",
      "./img2/decide/decide_c3_a7_sf8.png",
      "./img2/decide/decide_c1_a8_sf1.png",
      "./img2/decide/decide_c1_a8_sf2.png",
      "./img2/decide/decide_c1_a8_sf3.png",
      "./img2/decide/decide_c1_a8_sf4.png",
      "./img2/decide/decide_c1_a8_sf5.png",
      "./img2/decide/decide_c1_a8_sf6.png",
      "./img2/decide/decide_c1_a8_sf7.png",
      "./img2/decide/decide_c1_a8_sf8.png",
      "./img2/decide/decide_c2_a8_sf1.png",
      "./img2/decide/decide_c2_a8_sf2.png",
      "./img2/decide/decide_c2_a8_sf3.png",
      "./img2/decide/decide_c2_a8_sf4.png",
      "./img2/decide/decide_c2_a8_sf5.png",
      "./img2/decide/decide_c2_a8_sf6.png",
      "./img2/decide/decide_c2_a8_sf7.png",
      "./img2/decide/decide_c2_a8_sf8.png",
      "./img2/decide/decide_c3_a8_sf1.png",
      "./img2/decide/decide_c3_a8_sf2.png",
      "./img2/decide/decide_c3_a8_sf3.png",
      "./img2/decide/decide_c3_a8_sf4.png",
      "./img2/decide/decide_c3_a8_sf5.png",
      "./img2/decide/decide_c3_a8_sf6.png",
      "./img2/decide/decide_c3_a8_sf7.png",
      "./img2/decide/decide_c3_a8_sf8.png",
      "./img2/decide/decide_c4_a1_sf1.png",
      "./img2/decide/decide_c4_a1_sf2.png",
      "./img2/decide/decide_c4_a1_sf3.png",
      "./img2/decide/decide_c4_a1_sf4.png",
      "./img2/decide/decide_c4_a1_sf5.png",
      "./img2/decide/decide_c4_a1_sf6.png",
      "./img2/decide/decide_c4_a1_sf7.png",
      "./img2/decide/decide_c4_a1_sf8.png",
      "./img2/decide/decide_c4_a2_sf1.png",
      "./img2/decide/decide_c4_a2_sf2.png",
      "./img2/decide/decide_c4_a2_sf3.png",
      "./img2/decide/decide_c4_a2_sf4.png",
      "./img2/decide/decide_c4_a2_sf5.png",
      "./img2/decide/decide_c4_a2_sf6.png",
      "./img2/decide/decide_c4_a2_sf7.png",
      "./img2/decide/decide_c4_a2_sf8.png",
      "./img2/decide/decide_c4_a3_sf1.png",
      "./img2/decide/decide_c4_a3_sf2.png",
      "./img2/decide/decide_c4_a3_sf3.png",
      "./img2/decide/decide_c4_a3_sf4.png",
      "./img2/decide/decide_c4_a3_sf5.png",
      "./img2/decide/decide_c4_a3_sf6.png",
      "./img2/decide/decide_c4_a3_sf7.png",
      "./img2/decide/decide_c4_a3_sf8.png",
      "./img2/decide/decide_c4_a4_sf1.png",
      "./img2/decide/decide_c4_a4_sf2.png",
      "./img2/decide/decide_c4_a4_sf3.png",
      "./img2/decide/decide_c4_a4_sf4.png",
      "./img2/decide/decide_c4_a4_sf5.png",
      "./img2/decide/decide_c4_a4_sf6.png",
      "./img2/decide/decide_c4_a4_sf7.png",
      "./img2/decide/decide_c4_a4_sf8.png",
      "./img2/decide/decide_c4_a5_sf1.png",
      "./img2/decide/decide_c4_a5_sf2.png",
      "./img2/decide/decide_c4_a5_sf3.png",
      "./img2/decide/decide_c4_a5_sf4.png",
      "./img2/decide/decide_c4_a5_sf5.png",
      "./img2/decide/decide_c4_a5_sf6.png",
      "./img2/decide/decide_c4_a5_sf7.png",
      "./img2/decide/decide_c4_a5_sf8.png",
      "./img2/decide/decide_c4_a6_sf1.png",
      "./img2/decide/decide_c4_a6_sf2.png",
      "./img2/decide/decide_c4_a6_sf3.png",
      "./img2/decide/decide_c4_a6_sf4.png",
      "./img2/decide/decide_c4_a6_sf5.png",
      "./img2/decide/decide_c4_a6_sf6.png",
      "./img2/decide/decide_c4_a6_sf7.png",
      "./img2/decide/decide_c4_a6_sf8.png",
      "./img2/decide/decide_c4_a7_sf1.png",
      "./img2/decide/decide_c4_a7_sf2.png",
      "./img2/decide/decide_c4_a7_sf3.png",
      "./img2/decide/decide_c4_a7_sf4.png",
      "./img2/decide/decide_c4_a7_sf5.png",
      "./img2/decide/decide_c4_a7_sf6.png",
      "./img2/decide/decide_c4_a7_sf7.png",
      "./img2/decide/decide_c4_a7_sf8.png",
      "./img2/decide/decide_c4_a8_sf1.png",
      "./img2/decide/decide_c4_a8_sf2.png",
      "./img2/decide/decide_c4_a8_sf3.png",
      "./img2/decide/decide_c4_a8_sf4.png",
      "./img2/decide/decide_c4_a8_sf5.png",
      "./img2/decide/decide_c4_a8_sf6.png",
      "./img2/decide/decide_c4_a8_sf7.png",
      "./img2/decide/decide_c4_a8_sf8.png",
      medalImgStr,
      "./img2/examples/dm_ex1_bal0.PNG",
      "./img2/examples/dm_ex1_bal1.PNG",
      "./img2/examples/dm_ex1_bal2.PNG",
      "./img2/examples/dm_ex1_bal3.PNG",
      "./img2/examples/dm_ex2_bal0.PNG",
      "./img2/examples/dm_ex2_bal1.PNG",
      "./img2/examples/dm_ex2_bal2.PNG",
      "./img2/examples/dm_ex2_bal3.PNG",
      "./img2/examples/dm_ex3_bal0.PNG",
      "./img2/examples/dm_ex3_bal1.PNG",
      "./img2/examples/dm_ex3_bal2.PNG",
      "./img2/examples/dm_ex3_bal3.PNG",
      "./img2/examples/or_hor_to_vert.PNG",
      "./img2/examples/or_vert_to_hor.PNG",
      "./img2/examples/sf_thick_to_thin.PNG",
      "./img2/examples/sf_thin_to_thick.PNG",
      "./img2/examples/search_example_blue.PNG",
      "./img2/examples/search_example_orange.PNG",
    ];

    if (realVersion) {
      var numSearchBlocks = 2; // how many search blocks before the DM task is introduced
      var numSearchBlocksMini = 1; // how many search blocks in each mini block (after the DM task is introduced)
      var numDmBlocksMini = 1; // how many DM blocks in each mini block (after the DM task is introduced)
      var numMiniBlocks = 7; // how many mini blocks (after the DM task is introduced)
      var numBlocksTotal =
        numSearchBlocks +
        1 +
        numMiniBlocks * (numDmBlocksMini + numSearchBlocksMini);
      var numSearchPracTrials = 8;
      var numDistractorTrials = 9;
      var numAbsentTrials = 9;
      var numSearchTrialsPerBlock = numDistractorTrials * 2 + numAbsentTrials;
      var numDmPracTrials = 10;
      var numDmTrialsPerTrialType = 3; // This needs to be a multiple of 3
      var numDominanceRepeats = numDmTrialsPerTrialType / 3;
      var numDmTrialTypes = 3;
      var numDmColourTypes = 3;
      var numDmTrialsPerBlock =
        numDmTrialsPerTrialType * numDmTrialTypes * numDmColourTypes;
      var initialPauseDuration = 1000;
      var itiDuration = 1000;
      var fixationDuration = 400;
      var pracFBDuration = [3000, 1000];
      var exptFBDuration = 1100;
      var dmPracticeFBduration = 3000;
      var dmFBduration = 1100;
      var errorFBDuration = 1500;
      var anticipationFBDuration = 2500;
      var timeoutDuration = 2000;
      var dmTimeoutDuration = 1500;
      var dmPracticeTimeoutDuration = 2500;
      var zeroPayRT = 1400;
      var anticipationLimit = 150;
      var choiceTypeReps = 1;
      var choiceFB_duration = 1000;
      var choiceTest_iti = 500;
    } else {
      var numSearchBlocks = 2;
      var numSearchPracTrials = 4;
      var numDistractorTrials = 6;
      var numAbsentTrials = 2;
      var initialPauseDuration = 1; // 1000
      var itiDuration = 1; // 500
      var fixationDuration = 1; // 500
      var pracFBDuration = [1, 1]; // 700
      var exptFBDuration = 1; // 800
      var anticipationFBDuration = 1; // 2000
      var timeoutDuration = 10000;
      var zeroPayRT = 1000;
      var anticipationLimit = 1;
    }

    // ******************* SET TRIAL TYPES - SEARCH TASK ******************

    var distractType = [];
    var distractLoc = [];
    var targetLoc = [];

    var tempArray = [];
    var tempCount = 0;

    // distractor trials
    for (dt = 0; dt < 2; dt++) {
      for (dTrials = 0; dTrials < numDistractorTrials; dTrials++) {
        distractType[tempCount] = dt;
        distractLoc[tempCount] = 99;
        targetLoc[tempCount] = 99; // This will be chosen randomly later
        tempCount++;
      }
    }

    // distractor absent trials
    for (aTrials = 0; aTrials < numAbsentTrials; aTrials++) {
      distractType[tempCount] = 2;
      distractLoc[tempCount] = 99;
      targetLoc[tempCount] = 99; // This will be chosen randomly later
      tempCount++;
    }

    var numTrialsPerBlock = distractType.length;

    var trialSelector = [];
    for (ii = 0; ii < numTrialsPerBlock; ii++) {
      trialSelector[ii] = ii;
    }
    shuffleArray(trialSelector);

    var dmTrialSelector = [];
    for (ii = 0; ii < numDmTrialsPerBlock; ii++) {
      dmTrialSelector[ii] = ii;
    }
    shuffleArray(dmTrialSelector);

    var choiceType = []; // Index 1 is choice type, index 2 is presentation order
    for (ii = 0; ii < choiceTypeReps * 2; ii++) {
      choiceType[ii] = [];
    }

    var tempCount = 0;
    var tempCount2 = 0;
    var tc3 = 0;
    for (dt = 0; dt < 2; dt++) {
      for (ii = 0; ii < choiceTypeReps; ii++) {
        choiceType[tempCount2][0] = tempCount;
        choiceType[tempCount2][1] = Math.round(Math.random());
        tempCount2++;
      }
      tempCount++;
      tc3 = 0;
    }

    var numChoiceTrials = choiceType.length;
    var choiceSelector = [];
    for (ii = 0; ii < numChoiceTrials; ii++) {
      choiceSelector[ii] = ii;
    }
    shuffleArray(choiceSelector);

    var numSearchTestTrials = 1;

    // ******************* SET TRIAL TYPES - DM TASK ******************
    var dmTrialType = []; // 0 = coloured best, 1 = coloured medium, 2 = coloured worst
    var dmTargetLoc = [];
    // var numDmTrials = 8;
    var dmColourType = [];
    var dmDominanceType = [];
    var poss_dm_locs = [0, 2, 4];

    var possValues = [10, 80, 150, 220, 290, 360, 430, 500];
    var possProbabilities = [
      1 / 8,
      2 / 8,
      3 / 8,
      4 / 8,
      5 / 8,
      6 / 8,
      7 / 8,
      1,
    ];

    switch (dmBalance) {
      case 0:
        var valCodes = [1, 2, 3, 4, 5, 6, 7, 8];
        var probCodes = [1, 2, 3, 4, 5, 6, 7, 8];
        break;
      case 1:
        var valCodes = [8, 7, 6, 5, 4, 3, 2, 1];
        var probCodes = [1, 2, 3, 4, 5, 6, 7, 8];
        break;
      case 2:
        var valCodes = [1, 2, 3, 4, 5, 6, 7, 8];
        var probCodes = [8, 7, 6, 5, 4, 3, 2, 1];
        break;
      case 3:
        var valCodes = [8, 7, 6, 5, 4, 3, 2, 1];
        var probCodes = [8, 7, 6, 5, 4, 3, 2, 1];
        break;
    }

    var dmTrialValue = [];
    var dmTrialValueIdx = [];
    var dmTrialProbability = [];
    var dmTrialProbIdx = [];
    var dmTrialEV = [];

    var tempProbsIdx = [];
    var tempProbs = [];
    var tempValIdx = [];
    var tempVals = [];
    var tempEVs = [];
    var tempEVsSorted = [];
    var tempRanks = [];
    var tempCount = 0;
    var duplicateRank;

    var dmDominanceBase = [0, 0, 1]; // if dmDominance equals 1, then the highest EV option has both higher value and higher probability than other options. 2/3 of the time this is not the case (as per Gluth 2018)

    const makeRepeated = (arr, repeats) =>
      [].concat(...Array.from({ length: repeats }, () => arr));

    var dmDominance = makeRepeated(dmDominanceBase, numDominanceRepeats);

    generateDMTrials(
      numDmColourTypes,
      numDmTrialTypes,
      numDmTrialsPerTrialType,
      dmDominance
    );

    // ******************* CREATE AND SET VARIOUS USEFUL VARIABLES ******************

    var fbFontSize = 150;

    var trialCorrect;
    var pointsInBlock = 0;

    var bonusTrialStr =
      '<p style="color:black; background-color:yellow; font-weight:bold; white-space:pre; font-size:' +
      fbFontSize +
      '%;line-height:180%;margin:10px;">   BONUS TRIAL!   </p><p style="white-space:pre;font-size:10%;margin:10px;"> </p>';
    var bonusTrialStrInvisible =
      '<p style="white-space:pre;font-size:10%;margin:10px;"> </p><p style="color:black; background-color:black; font-weight:bold; white-space:pre; font-size:' +
      fbFontSize +
      '%;line-height:180%;margin:10px;">   BONUS TRIAL!   </p>'; // This is entirely black - it will be used for making sure the 'points' feedback text is vertically centred

    var errorFbStr = "<b>Error</b><br><br>";
    var timeoutFbStr = "<b>Too slow</b><br><br>";
    var couldHaveWonStr = "Could have won: ";
    var anticipationFbStr =
      '<p style="font-size:130%;line-height:140%;"><b>Please do not anticipate<br>which response to make</b></p>';
    var pointOrPoints = [" point", " points"];

    var oneMSvalue = 0.05;
    var highRewardMultiplier = 10;

    var sf_instruction_str = [];

    sf_instruction_str[0] = ["thin", "thick"];
    sf_instruction_str[1] = ["thick", "thin"];
    sf_instruction_str[2] = ["thin", "thick"];
    sf_instruction_str[3] = ["thick", "thin"];

    var sf_suffix_str = [];
    sf_suffix_str = ["ner", "er", "ner", "er"];

    var orientation_instruction_str = [];

    orientation_instruction_str[0] = ["horizontal", "vertical"];
    orientation_instruction_str[1] = ["horizontal", "vertical"];
    orientation_instruction_str[2] = ["vertical", "horizontal"];
    orientation_instruction_str[3] = ["vertical", "horizontal"];

    // var rewardValues = [500,10,10]

    var blockNum = 0;
    var trialNum = 0;
    var dmBlockNum = 0;
    var searchBlockNum = 0;
    var miniBlockNum = 0;
    var dmTrialNum = 0;
    var trialNumInBlock = 0;
    var totalPoints = 0;

    var p_age = "";
    var p_gender = "";
    var p_language = "";
    var p_country = "";

    // ******************* MAIN TASK TRIALS ******************
    var trialDistractLoc;
    var trialDistractType;
    var trialTargetLoc;
    var trialTargetOrient;
    var trialCorrect;
    var trialRT;
    var trialFBduration;
    var trialFeedbackText;
    var trialPoints;
    var trialLineArray = [];

    var preload_stimuli = {
      type: "preload",
      auto_preload: false,
      show_progress_bar: false,
      max_load_time: 300000,
      show_detailed_errors: true,
      images: imageFilenames,
    };

    var run_setTrialParameters = {
      type: "html-keyboard-response-mlp",
      stimulus: function () {
        if (exptPhase == 0) {
          trialDistractType = 3;
          trialDistractLoc = 99;
          trialTargetLoc = 99;
        } else {
          trialDistractType = distractType[trialSelector[trialNumInBlock]];
          trialDistractLoc = distractLoc[trialSelector[trialNumInBlock]];
          trialTargetLoc = targetLoc[trialSelector[trialNumInBlock]];
        }

        if (trialTargetLoc == 99) {
          trialTargetLoc = Math.floor(Math.random() * numStimLocs);
        }

        if (trialDistractLoc == 99) {
          do trialDistractLoc = Math.floor(Math.random() * numStimLocs);
          while (trialTargetLoc == trialDistractLoc);
        }

        trialTargetOrient = Math.round(Math.random()) + 1;
        for (ii = 0; ii < numStimLocs; ii++) {
          trialLineArray[ii] = Math.round(Math.random()) + 1;
        }
        trialLineArray[trialTargetLoc] = trialTargetOrient;

        return " ";
      },
      trial_duration: 10,
      response_ends_trial: false,
    };

    var setExampleTrialParameters = {
      type: "html-keyboard-response-mlp",
      stimulus: function () {
        trialDistractType = 1;
        trialDistractLoc = 99;
        trialTargetLoc = 99;

        if (trialTargetLoc == 99) {
          trialTargetLoc = Math.floor(Math.random() * numStimLocs);
        }

        if (trialDistractLoc == 99) {
          do trialDistractLoc = Math.floor(Math.random() * numStimLocs);
          while (trialTargetLoc == trialDistractLoc);
        }

        trialTargetOrient = Math.round(Math.random()) + 1;
        for (ii = 0; ii < numStimLocs; ii++) {
          trialLineArray[ii] = Math.round(Math.random()) + 1;
        }
        trialLineArray[trialTargetLoc] = trialTargetOrient;

        return " ";
      },
      trial_duration: 10,
      response_ends_trial: false,
    };

    var run_searchDisplay = {
      type: "visual-search-gabor",
      set_size: numStimLocs,
      search_stim_size: [100, 100],
      search_placeholder_size: [120, 120],
      fixation_size: [30, 30],
      circle_diameter: 300,
      check_focus_interval: 1200,
      search_stimuli: function () {
        var searchArray = [];
        for (ii = 0; ii < numStimLocs; ii++) {
          searchArray[ii] = distractStr[2];
        }

        searchArray[trialDistractLoc] = distractStr[trialDistractType];
        searchArray[trialTargetLoc] = searchTargetStr;

        for (ii = 0; ii < numStimLocs; ii++) {
          searchArray[ii] = searchArray[ii] + trialLineArray[ii] + ".png";
        }

        return searchArray;
      },
      target_type: function () {
        return trialTargetOrient;
      },
      trial_duration: timeoutDuration,
      fixation_duration: fixationDuration,
      fixation_image: "./img2/search/fixationCross.png",
      on_finish: function (data) {
        trialCorrect = data.correct;
        trialRT = data.rt;

        trialPoints = 0;
        couldHaveWonPoints = 0;
        trialFeedbackText = "<p style='font-size:" + fbFontSize + "%;'>";

        if (exptPhase == 0) {
          trialFBduration = pracFBDuration[0];
          if (trialCorrect == 99) {
            trialFeedbackText += timeoutFbStr;
          } else if (trialCorrect == 0) {
            trialFeedbackText +=
              "<b>Error</b><br><br>If the lines inside the diamond are horizontal, press C<br><br>If the lines are vertical, press M";
          } else if (trialCorrect == 1) {
            trialFeedbackText += "Correct";
            trialFBduration = pracFBDuration[1];
            // rtStore.push(trialRT); // add to rtStore
          }
        } else {
          trialFBduration = exptFBDuration;

          if (trialCorrect == 99) {
            trialFeedbackText += timeoutFbStr;
            trialFBduration = errorFBDuration;
          } else {
            if (trialRT < anticipationLimit) {
              trialCorrect = 98;
              trialFeedbackText = anticipationFbStr;
              trialFBduration = anticipationFBDuration;
            } else {
              if (trialRT < zeroPayRT) {
                trialPoints = oneMSvalue * (zeroPayRT - data.rt);
                if (trialDistractType == 0) {
                  trialPoints = trialPoints * highRewardMultiplier;
                }
                trialPoints = Math.round(trialPoints);

                if (trialCorrect == 1) {
                  trialFeedbackText =
                    "<p style='font-size:" + fbFontSize + "%;color:white;'>";
                  trialFeedbackText += "+" + trialPoints + " points";
                } else if (trialCorrect == 0) {
                  trialFeedbackText +=
                    errorFbStr + "LOSE " + trialPoints + " points";
                  trialPoints = -trialPoints; //
                  trialFBduration = errorFBDuration;
                }
              } else {
                // If RT greater than zero-pay threshold

                if (trialCorrect == 1) {
                  trialFeedbackText += timeoutFbStr;
                } else if (trialCorrect == 0) {
                  // trialPoints = -1*rewardValues[0];
                  trialFeedbackText += errorFbStr + timeoutFbStr;
                  trialFBduration = errorFBDuration;
                }
              }
            } // anticipation
          } // timeout

          var fbTotalPoints = totalPoints + trialPoints;

          trialFeedbackText +=
            "</p><p style='font-size:100%;'>Total: " +
            fbTotalPoints.toLocaleString();
        }

        trialFeedbackText += "</p>";
        totalPoints += trialPoints;
        pointsInBlock += trialPoints;

        var tempStrArray = "";
        for (ii = 0; ii < numStimLocs; ii++) {
          tempStrArray += trialLineArray[ii] + ";";
        }

        jsPsych.data.addDataToLastTrial({
          exptPhase: exptPhase,
          blockNum: blockNum,
          searchBlockNum: searchBlockNum,
          epoch: epoch,
          trialNum: trialNum,
          trialNumInBlock: trialNumInBlock,
          trialDistractType: trialDistractType,
          trialDistractLoc: trialDistractLoc,
          trialTargetLoc: trialTargetLoc,
          trialTargetOrient: trialTargetOrient,
          trialCorrect: trialCorrect,
          trialPoints: trialPoints,
          totalPoints: totalPoints,
          trialLineArray: tempStrArray,
          trialThresholdRT: zeroPayRT,
        });
      },
    };

    var run_searchFeedback = {
      type: "html-keyboard-response-mlp",
      stimulus: function () {
        var tempFbStr;
        if (trialDistractType == 0) {
          tempFbStr =
            bonusTrialStr + trialFeedbackText + bonusTrialStrInvisible;
        } else {
          tempFbStr = trialFeedbackText;
        }
        return tempFbStr;
      },
      trial_duration: function () {
        return trialFBduration;
      },
      response_ends_trial: false,
      post_trial_gap: itiDuration,
    };

    var run_search_trial = {
      timeline: [run_setTrialParameters, run_searchDisplay, run_searchFeedback],
    };

    // ******************** DECISION MAKING TRIALS *******************************

    var trialDMColourType;
    var trialDMTrialType;
    var trialDMTargetLoc;
    var trialDMColourLoc;
    var trialDMFBduration;

    var trialDMLocs = [];
    var trialDmEvs;
    var trialDmVals;
    var trialDmValsIdx;
    var trialDmProbs;
    var trialDmProbIdx;
    var trialDmDominanceType;

    var run_setDMTrialParameters = {
      type: "html-keyboard-response-mlp",
      stimulus: function () {
        if (exptPhase == 2) {
          trialDMColourType = 3;
          trialDMFBduration = dmPracticeFBduration;
        } else {
          trialDMColourType = dmColourType[dmTrialSelector[trialNumInBlock]];
          trialDMFBduration = dmFBduration;
        }
        trialDMTrialType = dmTrialType[dmTrialSelector[trialNumInBlock]];
        trialDmDominanceType =
          dmDominanceType[dmTrialSelector[trialNumInBlock]];
        trialDMTargetLoc = 99;
        trialDMColourLoc = 99;
        trialDMLocs = [];
        trialDmEvs = dmTrialEV[dmTrialSelector[trialNumInBlock]];
        trialDmVals = dmTrialValue[dmTrialSelector[trialNumInBlock]];
        trialDmValsIdx = dmTrialValueIdx[dmTrialSelector[trialNumInBlock]];
        trialDmProbs = dmTrialProbability[dmTrialSelector[trialNumInBlock]];
        trialDmProbIdx = dmTrialProbIdx[dmTrialSelector[trialNumInBlock]];

        trialEVsSorted = trialDmEvs.slice().sort((a, b) => b - a);
        trialEVRanks = trialEVsSorted.map((v) => trialDmEvs.indexOf(v));

        var trial_poss_dm_locs = [...poss_dm_locs];

        if (trialDMTargetLoc == 99) {
          trialDMTargetLoc = trial_poss_dm_locs.splice(
            Math.floor(Math.random() * 3),
            1
          );
        }

        if (trialDMTrialType == 0) {
          trialDMColourLoc = trialDMTargetLoc;
          trialDMLocs[0] = trialDMColourLoc;
          trialDMLocs[1] = trial_poss_dm_locs.splice(
            Math.floor(Math.random() * 2),
            1
          );
          trialDMLocs[2] = trial_poss_dm_locs.splice(
            Math.floor(Math.random() * 1),
            1
          );
        } else {
          trialDMColourLoc = trial_poss_dm_locs.splice(
            Math.floor(Math.random() * 2),
            1
          );

          trialDMLocs[0] = trialDMColourLoc;

          if (trialEVRanks.indexOf(0) == 1) {
            trialDMLocs[1] = trialDMTargetLoc;
            trialDMLocs[2] = trial_poss_dm_locs.splice(
              Math.floor(Math.random() * 1)
            );
          } else {
            trialDMLocs[2] = trialDMTargetLoc;
            trialDMLocs[1] = trial_poss_dm_locs.splice(
              Math.floor(Math.random() * 1)
            );
          }
        }

        // need this here to flatten the location array that gets made above
        trialDMLocs = [].concat.apply([], trialDMLocs);

        return " ";
      },
      trial_duration: 10,
      response_ends_trial: false,
    };

    var run_setDMExampleTrialParameters = {
      type: "html-keyboard-response-mlp",
      stimulus: function () {
        trialDMColourType = 3;
        trialDMFBduration = dmPracticeFBduration;

        trialDMTrialType = 2;
        trialDMTargetLoc = 99;
        trialDMColourLoc = 99;
        trialDMLocs = [];
        trialDmVals = [500, 290, 10]; // setting up so that coloured is medium value dmTrialValue[dmTrialSelector[trialNumInBlock]];
        // trialDmValsIdx = dmTrialValueIdx[dmTrialSelector[trialNumInBlock]];
        trialDmProbs = [4 / 8, 8 / 8, 1 / 8]; // dmTrialProbability[dmTrialSelector[trialNumInBlock]];
        // trialDmProbIdx = dmTrialProbIdx[dmTrialSelector[trialNumInBlock]];
        trialDmEvs = [145, 36.25, 290];

        trialEVsSorted = trialDmEvs.slice().sort((a, b) => b - a);
        trialEVRanks = trialEVsSorted.map((v) => trialDmEvs.indexOf(v));

        var trial_poss_dm_locs = [...poss_dm_locs];

        if (trialDMTargetLoc == 99) {
          trialDMTargetLoc = trial_poss_dm_locs.splice(
            Math.floor(Math.random() * 3),
            1
          );
        }

        trialDMLocs[0] = 0;
        trialDMLocs[1] = 2;
        trialDMLocs[2] = 4;

        // if (trialDMTrialType == 0) {
        //   trialDMColourLoc = trialDMTargetLoc;
        //   trialDMLocs[0] = trialDMColourLoc;
        //   trialDMLocs[1] = trial_poss_dm_locs.splice(
        //     Math.floor(Math.random() * 2),
        //     1
        //   );
        //   trialDMLocs[2] = trial_poss_dm_locs.splice(
        //     Math.floor(Math.random() * 1),
        //     1
        //   );
        // } else {
        //   trialDMColourLoc = trial_poss_dm_locs.splice(
        //     Math.floor(Math.random() * 2),
        //     1
        //   );

        //   trialDMLocs[0] = trialDMColourLoc;

        //   if (trialEVRanks.indexOf(0) == 1) {
        //     trialDMLocs[1] = trialDMTargetLoc;
        //     trialDMLocs[2] = trial_poss_dm_locs.splice(
        //       Math.floor(Math.random() * 1)
        //     );
        //   } else {
        //     trialDMLocs[2] = trialDMTargetLoc;
        //     trialDMLocs[1] = trial_poss_dm_locs.splice(
        //       Math.floor(Math.random() * 1)
        //     );
        //   }
        // }

        // need this here to flatten the location array that gets made above
        trialDMLocs = [].concat.apply([], trialDMLocs);

        return " ";
      },
      trial_duration: 10,
      response_ends_trial: false,
    };

    var run_DM_Display = {
      type: "dm-gabor",
      set_size: numStimLocs,
      search_stim_size: [100, 100],
      search_placeholder_size: [120, 120],
      fixation_size: [30, 30],
      circle_diameter: 300,
      check_focus_interval: 1200,
      dm_stimuli: function () {
        var dmArray = [
          dmPlaceholderStr,
          dmPlaceholderStr,
          dmPlaceholderStr,
          dmPlaceholderStr,
          dmPlaceholderStr,
          dmPlaceholderStr,
        ];

        // coloured shape first
        dmArray[trialDMLocs[0]] =
          dmStimStrBase[trialDMColourType] +
          probCodes[possProbabilities.indexOf(trialDmProbs[0])] +
          "_sf" +
          valCodes[possValues.indexOf(trialDmVals[0])] +
          ".png";

        // then the others
        dmArray[trialDMLocs[1]] =
          dmStimStrBase[2] +
          probCodes[possProbabilities.indexOf(trialDmProbs[1])] +
          "_sf" +
          valCodes[possValues.indexOf(trialDmVals[1])] +
          ".png";

        dmArray[trialDMLocs[2]] =
          dmStimStrBase[2] +
          probCodes[possProbabilities.indexOf(trialDmProbs[2])] +
          "_sf" +
          valCodes[possValues.indexOf(trialDmVals[2])] +
          ".png";

        return dmArray;
      },
      placeholder_stimuli: function () {
        return [];
      },
      prestim_placeholder_stimuli: function () {
        return [];
      },
      trial_duration: function () {
        if (exptPhase == 2) {
          return dmPracticeTimeoutDuration;
        } else {
          return dmTimeoutDuration;
        }
      },
      fixation_duration: fixationDuration,
      fixation_image: "./img2/search/fixationCross.png",
      on_finish: function (data) {
        trialChosen = data.chosen;
        trialRT = data.rt;

        trialFeedbackText = "<p style='font-size:" + fbFontSize + "%;'>";

        trialFBduration = exptFBDuration;

        trialColourChosen = 0;
        trialOptimalChoice = 0;
        trialChosenEV = 0;
        trialChosenVal = 0;
        trialChosenProb = 0;
        trialGambleWin = 0;
        trialMaxEV = Math.max(...trialDmEvs);
        trialPoints = 0;

        if (trialChosen == 99) {
          trialFeedbackText += timeoutFbStr;
          trialFBduration = errorFBDuration;
        } else {
          if (trialRT < anticipationLimit) {
            trialChosen = 98;
            trialFeedbackText = anticipationFbStr;
            trialFBduration = anticipationFBDuration;
          } else {
            trialChosenEV = trialDmEvs[trialDMLocs.indexOf(trialChosen)];
            trialChosenVal = trialDmVals[trialDMLocs.indexOf(trialChosen)];
            trialChosenProb = trialDmProbs[trialDMLocs.indexOf(trialChosen)];

            if (trialChosenEV == trialMaxEV) {
              trialOptimalChoice = 1;
            }

            if (trialChosen == trialDMColourLoc) {
              trialColourChosen = 1;
            }

            // gamble
            if (Math.random() <= trialChosenProb) {
              trialGambleWin = 1;
              trialPoints = trialChosenVal;
            }

            trialFeedbackText =
              "<p style='font-size:" + fbFontSize + "%;color:white;'>";

            trialFeedbackText += "+" + trialPoints + " points";

            if (exptPhase == 2) {
              trialFeedbackText +=
                "</p>" +
                "<p style='font-size:100" +
                "%;color:white;'>Your choice gave a " +
                Math.ceil(trialChosenProb * 100) +
                "&#37; chance of winning " +
                trialChosenVal +
                " points.</p><br>" +
                "<p style='font-size:100%" +
                ";color:white;'><b>Remember:</b><br><br>The " +
                sf_instruction_str[dmBalance][0] +
                sf_suffix_str[dmBalance] +
                " the lines, the more points you could win.<br><br>The closer the lines are to " +
                orientation_instruction_str[dmBalance][0] +
                ", the higher your chance of winning.</p>";
            }
          } // anticipation
        } // timeout

        var fbTotalPoints = totalPoints + trialPoints;

        if (exptPhase != 2) {
          trialFeedbackText +=
            "</p><p style='font-size:100%;'>Total: " +
            fbTotalPoints.toLocaleString();
        }

        trialFeedbackText += "</p>";
        if (exptPhase != 2) {
          totalPoints += trialPoints;
          pointsInBlock += trialPoints;
        }

        jsPsych.data.addDataToLastTrial({
          exptPhase: exptPhase,
          blockNum: blockNum,
          dmBlockNum: dmBlockNum,
          epoch: epoch,
          trialNum: dmTrialNum,
          trialNumInBlock: trialNumInBlock,
          trialDMColourType: trialDMColourType,
          trialDMTrialType: trialDMTrialType,
          trialDMDominanceType: trialDmDominanceType,
          trialDMTargetLoc: trialDMTargetLoc,
          trialDMColourLoc: trialDMColourLoc,
          trialDMLocs: trialDMLocs,
          trialChosen: trialChosen,
          trialOptimalChoice: trialOptimalChoice,
          trialColourChosen: trialColourChosen,
          trialChosenEV: trialChosenEV,
          trialColourEV: trialDmEvs[0],
          trialMaxEV: trialMaxEV,
          trialDmEvs: trialDmEvs,
          trialChosenVal: trialChosenVal,
          trialColourVal: trialDmVals[0],
          trialMaxVal: Math.max(...trialDmVals),
          trialDmVals: trialDmVals,
          trialChosenProb: trialChosenProb,
          trialColourProb: trialDmProbs[0],
          trialMaxProb: Math.max(...trialDmProbs),
          trialDmProbs: trialDmProbs,
          trialGambleWin: trialGambleWin,
          trialPoints: trialPoints,
          totalPoints: totalPoints,
        });
      },
    };

    var run_DM_Feedback = {
      type: "html-keyboard-response-mlp",
      stimulus: function () {
        var tempFbStr;
        tempFbStr = trialFeedbackText;
        return tempFbStr;
      },
      trial_duration: function () {
        if (exptPhase == 2) {
          return null;
        } else {
          return trialDMFBduration;
        }
      },
      response_ends_trial: function () {
        if (exptPhase == 2) {
          return true;
        } else {
          return false;
        }
      },
      prompt: function () {
        if (exptPhase == 2) {
          return "<p style='font-size:100%;'>Press any key to continue</p>";
        } else {
          return null;
        }
      },
      prompt_delay: function () {
        if (exptPhase == 2) {
          return dmPracticeFBduration;
        } else {
          return null;
        }
      },
      choices: jsPsych.ALL_KEYS,
      response_delay: function () {
        if (exptPhase == 2) {
          return dmPracticeFBduration;
        } else {
          return null;
        }
      },
      post_trial_gap: itiDuration,
    };

    var run_dm_trial = {
      timeline: [run_setDMTrialParameters, run_DM_Display, run_DM_Feedback],
    };

    // ******************* BREAKS *****************

    var pointsPerMedal =
      Math.floor((goodBlockScore * numBlocksTotal) / (6 * 10)) * 10; // Divided by 6 as Elite is level 6, and rounded down to nearest 100

    if (realVersion == false) {
      console.log("ppm " + pointsPerMedal);
    }

    var currentMedalLevel = 0;
    var previousMedalLevel = 0;

    // ******************* LOOPS ******************

    var run_practice_phase = {
      timeline: [run_search_trial],
      loop_function: function () {
        trialNum++;
        trialNumInBlock++;
        if (trialNumInBlock < numSearchPracTrials) {
          return true;
        } else {
          trialNum = 0;
          trialNumInBlock = 0;
          return false;
        }
      },
    };

    var main_task_trial_block = {
      timeline: [run_search_trial],
      loop_function: function () {
        trialNum++;
        trialNumInBlock++;
        if (trialNumInBlock < numTrialsPerBlock) {
          return true;
        } else {
          trialNumInBlock = 0;
          return false;
        }
      },
    };

    var run_dm_practice_phase = {
      timeline: [run_dm_trial],
      on_timeline_start: function () {
        exptPhase = 2;
        // trialNumInBlock = 0;
      },
      loop_function: function () {
        trialNum++;
        trialNumInBlock++;
        if (trialNumInBlock < numDmPracTrials) {
          return true;
        } else {
          trialNum = 0;
          trialNumInBlock = 0;
          return false;
        }
      },
    };

    var dm_task_trial_block = {
      timeline: [run_dm_trial],
      on_timeline_start: function () {
        // exptPhase = 3;
        // trialNumInBlock = 0;
      },
      loop_function: function () {
        dmTrialNum++;
        trialNumInBlock++;
        if (trialNumInBlock < numDmTrialsPerBlock) {
          return true;
        } else {
          trialNumInBlock = 0;
          return false;
        }
      },
    };

    var blockBreakScreen1 = {
      type: "html-keyboard-response-mlp",
      stimulus: function () {
        previousMedalLevel = currentMedalLevel;
        currentMedalLevel = Math.floor(totalPoints / pointsPerMedal);
        if (currentMedalLevel > numMedals) {
          currentMedalLevel = numMedals;
        }
        var nextMedalPoints = (currentMedalLevel + 1) * pointsPerMedal;

        var newMedal = false;
        if (previousMedalLevel != currentMedalLevel) {
          newMedal = true;
        }

        var tempTextHTML =
          "<p style='white-space:pre;'>You're doing well!   " +
          (blockNum + 1) +
          " of " +
          numBlocksTotal +
          " blocks completed.</p>";
        tempTextHTML +=
          "<p>In the previous block of trials, you won " +
          numberWithCommas(pointsInBlock) +
          " points.</p><p style='font-size:130%;'><b>You currently have a total of " +
          numberWithCommas(totalPoints) +
          " points</b><br><br></p>";

        if (newMedal) {
          tempTextHTML +=
            "<p style='color:yellow; font-size:115%'>You've unlocked a new medal!</p>";
        }

        tempTextHTML += "<p>";
        for (ii = 0; ii < currentMedalLevel; ii++) {
          if (ii == currentMedalLevel - 1) {
            tempTextHTML += '<img src="' + medalImgStr[ii] + '">';
          } else {
            tempTextHTML +=
              '<img src="' + medalImgStr[ii] + '" style="opacity:0.4">';
          }
        }
        tempTextHTML += "<br><br></p>";
        if (currentMedalLevel != numMedals) {
          tempTextHTML +=
            '<p style="color:cyan; font-size:115%;">Next medal unlocks at ' +
            numberWithCommas(nextMedalPoints) +
            " points<br><br></p>";
        }
        tempTextHTML += "<p>Press space when you are ready to continue</p>";
        pointsInBlock = 0;
        return tempTextHTML;
      },
      choices: [" "],
      check_focus_interval: 1500,
      post_trial_gap: 0,
      on_finish: function () {
        jsPsych.data.addDataToLastTrial({
          currentMedal: currentMedalLevel,
        });
        if (jatosVersion == true) {
          // var result_for_JATOS = jsPsych.data.get().ignore(fieldsToIgnore).json();
          var result_for_JATOS = jsPsych.data
            .get()
            .ignore(fieldsToIgnore)
            .json();
          // .csv();
          jatos.submitResultData(result_for_JATOS);
        }
      },
    };

    var blockBreakScreen2 = {
      type: "html-keyboard-response-mlp",
      stimulus:
        "<p style='font-size:130%; line-height:140%'><b>REMEMBER: THE MORE POINTS YOU HAVE AT THE END OF<br>THIS TASK, THE MORE LIKELY YOU ARE TO RECEIVE<br>" +
        prizeStrShort.toUpperCase() +
        "</b></p><p><br>Please place your fingers on the C and M keys and<br>press any key when you are ready to continue</p>",
      post_trial_gap: initialPauseDuration,
    };

    var blockBreakScreen3 = {
      type: "html-keyboard-response-mlp",
      stimulus: function () {
        if (exptPhase == 3) {
          return (
            "<p style='font-size:130%; line-height:140%'>In the next block of trials, you will be doing the <b>SEARCH TASK</b>." +
            "</p><p>Remember: Your task is to search for the target and diamond. Press 'C' if the lines inside the diamond are horizontal, and press 'M' if the lines inside the diamond are vertical." +
            "</p><p>Please place your fingers on the C and M keys and<br>press either key when you are ready to continue</p>"
          );
        } else {
          return (
            "<p style='font-size:130%; line-height:140%'>In the next block of trials, you will be doing the <b>CHOICE TASK</b>." +
            "</p><p>Remember: The " +
            sf_instruction_str[dmBalance][0] +
            sf_suffix_str[dmBalance] +
            " the lines, the more points you could win. The closer the lines are to " +
            orientation_instruction_str[dmBalance][0] +
            ", the higher your chance of winning" +
            "</p><p>Please place your fingers on the arrow keys and<br>press any arrow key when you are ready to continue</p>"
          );
        }
      },
      post_trial_gap: initialPauseDuration,
      choices: function () {
        if (exptPhase == 3) {
          return ["c", "m"];
        } else {
          return ["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"];
        }
      },
    };

    var checkBlockBreak2 = {
      // No block break screen 2 after final block
      timeline: [blockBreakScreen2],
      conditional_function: function () {
        if (
          ((exptPhase == 1) & (blockNum == numSearchBlocks - 1)) |
          ((exptPhase == 3) & (dmBlockNum == numDmBlocksMini - 1)) |
          ((exptPhase == 4) & (searchBlockNum == numSearchBlocksMini - 1))
        ) {
          return false;
        } else {
          return true;
        }
      },
    };

    var checkBlockBreak3 = {
      // Break screen before transitioning between tasks
      timeline: [blockBreakScreen3],
      conditional_function: function () {
        if (
          ((miniBlockNum == 0) & (exptPhase == 3)) |
          ((miniBlockNum == numMiniBlocks) & (exptPhase == 3))
        ) {
          return false;
        } else if (
          ((exptPhase == 3) & (dmBlockNum == numDmBlocksMini - 1)) |
          ((exptPhase == 4) & (searchBlockNum == numSearchBlocksMini - 1))
        ) {
          return true;
        } else {
          return false;
        }
      },
    };

    var run_main_task = {
      timeline: [main_task_trial_block, blockBreakScreen1, checkBlockBreak2],
      on_timeline_start: function () {
        exptPhase = 1;
        trialNumInBlock = 0;
      },
      loop_function: function () {
        blockNum++;
        shuffleArray(trialSelector);

        if (blockNum < numSearchBlocks) {
          return true;
        } else {
          return false;
        }
      },
    };

    var run_search_task_miniblock = {
      timeline: [main_task_trial_block, blockBreakScreen1, checkBlockBreak3],
      on_timeline_start: function () {
        exptPhase = 4;
        trialNumInBlock = 0;
        searchBlockNum = 0;
      },
      loop_function: function () {
        searchBlockNum++;
        miniBlockNum++;
        blockNum++;
        shuffleArray(trialSelector);

        if (searchBlockNum < numSearchBlocksMini) {
          return true;
        } else {
          return false;
        }
      },
    };

    var run_dm_task_miniblock = {
      timeline: [dm_task_trial_block, blockBreakScreen1, checkBlockBreak3],
      on_timeline_start: function () {
        exptPhase = 3;
        trialNumInBlock = 0;
        dmBlockNum = 0;
      },
      loop_function: function () {
        dmBlockNum++;
        // miniBlockNum++;
        blockNum++;
        shuffleArray(dmTrialSelector);
        // generate new set of values/probabilities for next dm block
        generateDMTrials(
          numDmColourTypes,
          numDmTrialTypes,
          numDmTrialsPerTrialType,
          dmDominance
        );

        if (dmBlockNum < numDmBlocksMini) {
          return true;
        } else {
          return false;
        }
      },
    };

    // ******************* POST-EXPT QUESTIONS ******************

    var tempImg1;
    var tempImg2;

    var choiceStim = [];
    for (ii = 0; ii < 3; ii++) {
      choiceStim[ii] = [];
    }

    // high value option
    choiceStim[0][0] =
      dmStimStrBase[2] +
      probCodes[4] +
      "_sf" +
      valCodes[valCodes.length - 1] +
      ".png";
    // low value option
    choiceStim[0][1] =
      dmStimStrBase[2] + probCodes[4] + "_sf" + valCodes[0] + ".png";
    // high probability option
    choiceStim[1][0] =
      dmStimStrBase[2] +
      probCodes[probCodes.length - 1] +
      "_sf" +
      valCodes[4] +
      ".png";
    // low probability option
    choiceStim[1][1] =
      dmStimStrBase[2] + probCodes[0] + "_sf" + valCodes[4] + ".png";
    searchStim = [
      distractStr[0] + Math.round(Math.random() + 1) + ".png",
      distractStr[1] + Math.round(Math.random() + 1) + ".png",
    ];

    chImgSz = 'width="80%" height="80%"';
    chBtnSz = "200px";

    var choiceStimStr = [];
    choiceStimStr[0] = "win you more points";
    choiceStimStr[1] = "have a higher chance of winning points";

    var searchTestDisplay = {
      type: "html-button-response",
      stimulus: function () {
        return (
          '<p style="font-size:130%; text-align:center">Please select the circle that you think would be in the search display on a BONUS trial' +
          " in the search task.<br><br></p>"
        );
      },
      choices: function () {
        if (trialChoiceOrder == 0) {
          tempImg1 = searchStim[0];
          tempImg2 = searchStim[1];
        } else {
          tempImg1 = searchStim[1];
          tempImg2 = searchStim[0];
        }
        return [
          "<img " + chImgSz + ' src="' + tempImg1 + '">',
          "<img " + chImgSz + ' src="' + tempImg2 + '">',
        ];
      },
      button_html:
        '<button class="choiceTestButton"><span>%choice%</span></button>',
      prompt:
        "<p><br>Please click on the display that you would like to select</p>",
      margin_horizontal: "30px",
      post_trial_gap: 100,
      on_finish: function (data) {
        trialPoints = 1000;
        if (data.button_pressed == trialChoiceOrder) {
          var chosenOption = 1;
        } else {
          var chosenOption = 2;
          trialPoints = 0;
        }

        totalPoints += trialPoints;

        jsPsych.data.addDataToLastTrial({
          exptPhase: exptPhase,
          trialNum: trialNum,
          trialNumInBlock: trialNumInBlock,
          // trialChoiceType: trialChoiceType,
          trialChoiceOrder: trialChoiceOrder,
          trialPoints: trialPoints,
          totalPoints: totalPoints,
          chosenOption: chosenOption,
        });
      },
    };

    var choiceTestDisplay = {
      type: "html-button-response",
      stimulus: function () {
        return (
          '<p style="font-size:130%; text-align:center">Please select the circle that you think would ' +
          choiceStimStr[trialChoiceType] +
          " in the choice task.<br><br></p>"
        );
      },
      choices: function () {
        if (trialChoiceOrder == 0) {
          tempImg1 = choiceStim[trialChoiceType][0];
          tempImg2 = choiceStim[trialChoiceType][1];
        } else {
          tempImg1 = choiceStim[trialChoiceType][1];
          tempImg2 = choiceStim[trialChoiceType][0];
        }
        return [
          "<img " + chImgSz + ' src="' + tempImg1 + '">',
          "<img " + chImgSz + ' src="' + tempImg2 + '">',
        ];
      },
      button_html:
        '<button class="choiceTestButton"><span>%choice%</span></button>',
      prompt:
        "<p><br>Please click on the circle that you would like to select</p>",
      margin_horizontal: "30px",
      post_trial_gap: 100,
      on_finish: function (data) {
        trialPoints = 1000;
        if (data.button_pressed == trialChoiceOrder) {
          var chosenOption = 1;
        } else {
          var chosenOption = 2;
          trialPoints = 0;
        }

        totalPoints += trialPoints;

        jsPsych.data.addDataToLastTrial({
          exptPhase: exptPhase,
          trialNum: trialNum,
          trialNumInBlock: trialNumInBlock,
          trialChoiceType: trialChoiceType,
          trialChoiceOrder: trialChoiceOrder,
          trialPoints: trialPoints,
          totalPoints: totalPoints,
          chosenOption: chosenOption,
        });
      },
    };

    var choiceTestFB = {
      type: "html-keyboard-response-mlp",
      stimulus: function () {
        if (trialPoints == 1000) {
          return '<p style="font-size:180%;line-height:140%; text-align:center">Correct! We have added 1000 points to your total<br><br></p>';
        } else {
          return '<p style="font-size:180%;line-height:140%; text-align:center">Incorrect<br><br></p>';
        }
      },
      trial_duration: choiceFB_duration,
      response_ends_trial: false,
      post_trial_gap: choiceTest_iti,
    };

    var run_choiceTestTrials1 = {
      timeline: [choiceTestDisplay, choiceTestFB],
      on_timeline_start: function () {
        trialChoiceType = 0;
        trialChoiceOrder = Math.floor(Math.random() * 2);
        exptPhase = 6;
      },
    };

    var run_choiceTestTrials2 = {
      timeline: [choiceTestDisplay, choiceTestFB],
      on_timeline_start: function () {
        trialChoiceType = 1;
        trialChoiceOrder = Math.floor(Math.random() * 2);
        exptPhase = 7;
      },
    };

    var run_searchTestTrials = {
      timeline: [searchTestDisplay, choiceTestFB],
      on_timeline_start: function () {
        trialChoiceOrder = Math.round(Math.random());
        exptPhase = 5;
      },
    };

    var expt_finished_questions = {
      type: "survey-text-mlp",
      preamble:
        '<p style="font-size:130%">Please type answers to the following questions in the boxes below.</p>',
      questions: [
        {
          prompt:
            "Were you distracted while you completed the task? e.g., by using your phone etc.",
          rows: 5,
          columns: 80,
        },
        {
          prompt: "Do you have any general comments about the experiment?",
          rows: 5,
          columns: 80,
        },
      ],
      post_trial_gap: 100,
      on_finish: function (data) {
        exptPhase = 7;
        var today = new Date();
        var endTime =
          today.getFullYear() +
          "-" +
          pad(today.getMonth() + 1, 2) +
          "-" +
          pad(today.getDate(), 2) +
          "_" +
          pad(today.getHours(), 2) +
          ":" +
          pad(today.getMinutes(), 2) +
          ":" +
          pad(today.getSeconds(), 2);
        jsPsych.data.addDataToLastTrial({
          exptPhase: exptPhase,
          endTime: endTime,
        });
        if (jatosVersion == true) {
          // var result_for_JATOS = jsPsych.data.get().ignore(fieldsToIgnore).json();
          var result_for_JATOS = jsPsych.data
            .get()
            .ignore(fieldsToIgnore)
            .json();
          // .csv();
          jatos.submitResultData(result_for_JATOS);
        } else {
          jsPsych.data
            .get()
            .ignore(fieldsToIgnore)
            .localSave("csv", "mydata.csv");
        }
      },
    };

    // ******************* INSTRUCTIONS ******************
    // ***************************************************
    // ***************************************************
    // ******************* INSTRUCTIONS SET 0 ******************

    var target_example =
      '<p style="text-align:center"><br><img src="' +
      targExFilename1 +
      '" style = "width:50%;height:50%;"><br></p>';
    var colour_example_html =
      '<p><div class="grid-container2"><div class="grid-item2"><img src="' +
      colourExImage[0] +
      '" style="width:100%"></div><div class="grid-item2"><img src="' +
      colourExImage[1] +
      '" style="width:100%"></div>' +
      '<div class="grid-item2" style="background-color:yellow">BONUS!</div>' +
      '<div class="grid-item2">No bonus</div></div></p>';

    var instructStr = [];
    var Q_prompt = [];
    var Q_answer = [];
    var correctString = [];

    var numQs = [];
    var maxQs = 7;

    for (ii = 0; ii < maxQs; ii++) {
      Q_prompt[ii] = [];
      Q_answer[ii] = [];
    }

    instructStr[0] = [
      '<p style="text-align:left">Thanks for agreeing to take part in this study, in which you will be asked to complete a <b>search task</b>.<br><br>Each trial will start with a cross appearing &ndash; this tells you that the search task is about to begin. A set of shapes will then appear. One of these shapes will be a diamond and the rest will be circles. This diamond is called the <b>target</b>. An example is shown below:<br></p>' +
        target_example,
      '<p style="text-align:left">Each of the shapes will contain lines, and your task is to respond to the lines that are contained in the target (i.e., the diamond).<br><br><b>If the lines inside the target are HORIZONTAL, you should press the C key.<br>If the lines are VERTICAL, you should press the M key.</b><br>You should respond as quickly as you can, but try to avoid making errors.<br></p>' +
        target_example,
      '<p style="text-align:left">On most of the trials, one of the circles in the display will be coloured.<br><br>Note, however, that <b>the target diamond will never be coloured. So the best strategy in this task is to ignore coloured shapes altogether, and respond to the target as quickly as possible.</b></p>' +
        target_example,
    ];

    numQs[0] = 3;

    Q_prompt[0][0] = "<b>What is the TARGET on each trial of this task?</b>";
    Q_answer[0][0] = [
      " The item that is a different colour from all the others.",
      " The diamond shape.",
    ];

    Q_prompt[0][1] = "<b>What is your aim in this task?</b>";
    Q_answer[0][1] = [
      " To respond based on the orientation of the lines inside the target diamond.",
      " To respond based on the length of the lines inside the target diamond.",
      " To rate how attractive different shapes are.",
    ];

    Q_prompt[0][2] = "<b>Which of these options is correct?</b>";
    Q_answer[0][2] = [
      " If the lines inside the target are horizontal I should press M; if the lines are vertical I should press C.",
      " If the lines inside the target are horizontal I should press C; if the lines are vertical I should press M.",
    ];

    correctString[0] =
      '{"Q0":"' +
      Q_answer[0][0][1] +
      '","Q1":"' +
      Q_answer[0][1][0] +
      '","Q2":"' +
      Q_answer[0][2][1] +
      '"}';

    //! ******************* INSTRUCTION SET 1 ***************************

    instructStr[1] = [
      '<p style="text-align:left;">The rest of this task is similar to the trials you have just completed. On each trial, you should respond to the lines contained inside the diamond.<br><br>If the lines are HORIZONTAL, you should press the C key.<br>If the lines are VERTICAL, you should press the M key.</p><br>',
      '<p style="text-align:left;">From now on, you will be able to earn points for correct responses. For every ' +
        numberWithCommas(pointsPerMedal) +
        " points you gain, you will unlock a medal.<br><br>Only around 10% of participants will unlock the ELITE medal - can you?<br><br></p>" +
        '<p style="text-align:center"><img src="' +
        medalDisplayFilename +
        '"><br></p>',
      '<p style="text-align:left;">Your aim should be to win as many points as possible. Not only do points unlock medals, but (perhaps more importantly) <b>the 25% of participants who earn the most points will each win ' +
        prizeStr +
        "</b>.<br><br>So if you are among the top-scoring 25% of participants, you will win a prize!</p><br>",
      '<p style="text-align:left;">The faster you make a correct response on each trial, the more points you will earn. But if you make an error, you will LOSE the corresponding amount. So you should try to respond as quickly and accurately as possible.</p><p style="text-align:left;font-size:110%;"><b>IMPORTANT: Some of the trials will be BONUS trials! The number of points available on bonus trials is much higher than on standard (non-bonus) trials.</p><p style="text-align:left;font-size:110%;">So you will earn much more for correct responses on bonus trials than on standard trials.</b></p><br>',
    ];

    numQs[1] = 3;

    Q_prompt[1][0] = "<b>How do you earn points in this task?</b>";
    Q_answer[1][0] = [
      " I will receive 10 points every time I make a correct response to the lines inside the target.",
      " The faster I make a correct response to the lines inside the target, the more points I will earn.",
      " I will not earn points during this part of the experiment.",
    ];

    Q_prompt[1][1] = "<b>Which of the following is true?</b>";
    Q_answer[1][1] = [
      " I will win the same number of points on every trial.",
      " Some trials will be 'bonus trials', on which I can win more points than on standard trials.",
      " I will win points even for incorrect responses.",
    ];

    Q_prompt[1][2] =
      "<b>What determines whether you will receive a prize of " +
      prizeStr +
      "?</b>";
    Q_answer[1][2] = [
      " I will receive a prize if the points that I earn during the experiment put me in the top-scoring 25% of participants.",
      " I will receive a prize if I make more correct responses than the average participant.",
      " I will receive a prize if I unlock the Elite medal",
    ];

    correctString[1] =
      '{"Q0":"' +
      Q_answer[1][0][1] +
      '","Q1":"' +
      Q_answer[1][1][1] +
      '","Q2":"' +
      Q_answer[1][2][0] +
      '"}';

    // ******************* INSTRUCTIONS SET 2 ******************

    instructStr[2] = [
      '<p style="text-align:left;line-height:280%">On some of the trials, one of the circles in the display will be coloured.<br><b>If ' +
        aOrAn[0] +
        colourName[0] +
        " circle is in the display, the trial WILL be a BONUS trial.<br>If " +
        aOrAn[1] +
        colourName[1] +
        " circle is in the display, the trial WILL NOT be a bonus trial.</b></p>" +
        colour_example_html,
      '<p style="text-align:left;">Note, however, that you should always respond to the DIAMOND.<br><br><b>The diamond will never be coloured. So the best strategy in this task (that will earn the most points) is to ignore the coloured shapes altogether, and respond to the diamond as quickly as possible.</b></p>',
    ];

    numQs[2] = 2;

    Q_prompt[2][0] =
      "<b>What type of trial will it be if the display contains " +
      aOrAn[1] +
      colourName[1] +
      " shape?</b>";
    Q_answer[2][0] = [" BONUS trial", " No bonus trial"];

    Q_prompt[2][1] =
      "<b>What type of trial will it be if the display contains " +
      aOrAn[0] +
      colourName[0] +
      " shape?</b>";
    Q_answer[2][1] = [" BONUS trial", " No bonus trial"];

    correctString[2] =
      '{"Q0":"' + Q_answer[2][0][1] + '","Q1":"' + Q_answer[2][1][0] + '"}';

    // ******************* INSTRUCTIONS DM TASK ******************

    console.log(dmBalance);

    var sf_example_str = [];

    sf_example_str[0] = ["left", "right", "top"];
    sf_example_str[1] = ["right", "left", "top"];
    sf_example_str[2] = ["left", "right", "top"];
    sf_example_str[3] = ["right", "left", "top"];

    var orientation_example_str = [];

    orientation_example_str[0] = ["right", "left", "top"];
    orientation_example_str[1] = ["right", "left", "top"];
    orientation_example_str[2] = ["left", "right", "top"];
    orientation_example_str[3] = ["left", "right", "top"];

    var dmExFilename1 = "./img2/examples/dm_ex";

    var dm_example_html = [];
    dm_example_html[0] =
      '<p style="text-align:center"><br><img src="' +
      "./img2/examples/dm_example.PNG" +
      '" style = "width:50%;height:50%;"><br></p>';

    if ((dmBalance == 0) | (dmBalance == 2)) {
      dm_example_html[1] =
        '<p style="text-align:center"><br><img src="' +
        "./img2/examples/sf_thin_to_thick.PNG" +
        '" style = "width:50%;height:50%;"><br></p>';
    } else {
      dm_example_html[1] =
        '<p style="text-align:center"><br><img src="' +
        "./img2/examples/sf_thick_to_thin.PNG" +
        '" style = "width:50%;height:50%;"><br></p>';
    }

    if ((dmBalance == 0) | (dmBalance == 1)) {
      dm_example_html[2] =
        '<p style="text-align:center"><br><img src="' +
        "./img2/examples/or_vert_to_hor.PNG" +
        '" style = "width:50%;height:50%;"><br></p>';
    } else {
      dm_example_html[2] =
        '<p style="text-align:center"><br><img src="' +
        "./img2/examples/or_hor_to_vert.PNG" +
        '" style = "width:50%;height:50%;"><br></p>';
    }

    for (ii = 3; ii < 6; ii++) {
      dm_example_html[ii] =
        '<p style="text-align:center"><br><img src="' +
        dmExFilename1 +
        (ii - 2) +
        "_bal" +
        dmBalance +
        ".PNG" +
        '" style = "width:50%;height:50%;"><br></p>';
    }

    var sfExImage = [];
    sfExImage[0] = [
      "./img2/decide/decide_c3_a4_sf1.png",
      "./img2/decide/decide_c3_a4_sf3.png",
      "./img2/decide/decide_c3_a4_sf6.png",
      "./img2/decide/decide_c3_a4_sf8.png",
    ]; //thin good, fat bad
    sfExImage[1] = [
      "./img2/decide/decide_c3_a4_sf8.png",
      "./img2/decide/decide_c3_a4_sf6.png",
      "./img2/decide/decide_c3_a4_sf3.png",
      "./img2/decide/decide_c3_a4_sf1.png",
    ]; //fat good, thin bad
    sfExImage[2] = [
      "./img2/decide/decide_c3_a4_sf1.png",
      "./img2/decide/decide_c3_a4_sf3.png",
      "./img2/decide/decide_c3_a4_sf6.png",
      "./img2/decide/decide_c3_a4_sf8.png",
    ]; //thin good, fat bad
    sfExImage[3] = [
      "./img2/decide/decide_c3_a4_sf8.png",
      "./img2/decide/decide_c3_a4_sf6.png",
      "./img2/decide/decide_c3_a4_sf3.png",
      "./img2/decide/decide_c3_a4_sf1.png",
    ]; //fat good, thin bad

    var orientationExImage = [];
    orientationExImage[0] = [
      "./img2/decide/decide_c3_a1_sf4.png",
      "./img2/decide/decide_c3_a3_sf4.png",
      "./img2/decide/decide_c3_a6_sf4.png",
      "./img2/decide/decide_c3_a8_sf4.png",
    ]; //horizontal good, vertical bad
    orientationExImage[1] = [
      "./img2/decide/decide_c3_a1_sf4.png",
      "./img2/decide/decide_c3_a3_sf4.png",
      "./img2/decide/decide_c3_a6_sf4.png",
      "./img2/decide/decide_c3_a8_sf4.png",
    ]; //horizontal good, vertical bad
    orientationExImage[2] = [
      "./img2/decide/decide_c3_a8_sf4.png",
      "./img2/decide/decide_c3_a6_sf4.png",
      "./img2/decide/decide_c3_a3_sf4.png",
      "./img2/decide/decide_c3_a1_sf4.png",
    ]; //vertical good, horizontal bad
    orientationExImage[3] = [
      "./img2/decide/decide_c3_a8_sf4.png",
      "./img2/decide/decide_c3_a6_sf4.png",
      "./img2/decide/decide_c3_a3_sf4.png",
      "./img2/decide/decide_c3_a1_sf4.png",
    ]; //vertical good, horizontal bad

    var sf_example_html =
      '<p><div class="grid-container"><div class="grid-item"><img src="' +
      sfExImage[dmBalance][0] +
      '" style="width:50%"></div><div class="grid-item"><img src="' +
      sfExImage[dmBalance][1] +
      '" style="width:50%"></div><div class="grid-item"><img src="' +
      sfExImage[dmBalance][2] +
      '" style="width:50%"></div><div class="grid-item"><img src="' +
      sfExImage[dmBalance][3] +
      '" style="width:50%"></div><div class="grid-line"></div>' +
      '<div class="grid-item2" style="fonts-size:24px">' +
      possValues[0] +
      " points</div>" +
      '<div class="grid-item2" style="fonts-size:24px">' +
      possValues[2] +
      " points</div>" +
      '<div class="grid-item2" style="fonts-size:24px">' +
      possValues[5] +
      " points</div>" +
      '<div class="grid-item2" style="fonts-size:24px">' +
      possValues[7] +
      " points</div>" +
      "</div></p>";

    var orientation_example_html =
      '<p><div class="grid-container"><div class="grid-item"><img src="' +
      orientationExImage[dmBalance][0] +
      '" style="width:50%"></div><div class="grid-item"><img src="' +
      orientationExImage[dmBalance][1] +
      '" style="width:50%"></div><div class="grid-item"><img src="' +
      orientationExImage[dmBalance][2] +
      '" style="width:50%"></div><div class="grid-item"><img src="' +
      orientationExImage[dmBalance][3] +
      '" style="width:50%"></div><div class="grid-line"></div>' +
      '<div class="grid-item2">' +
      possProbabilities[0] * 100 +
      "&#37;</div>" +
      '<div class="grid-item2">' +
      possProbabilities[2] * 100 +
      "&#37;</div>" +
      '<div class="grid-item2">' +
      possProbabilities[5] * 100 +
      "&#37;</div>" +
      '<div class="grid-item2">' +
      possProbabilities[7] * 100 +
      "&#37;</div>" +
      "</div></p>";

    instructStr[3] = [
      '<p style="text-align:left;">In the next part of the experiment, you will complete a <b>choice task</b>.<br><br>' +
        "On each trial, you will see three circles appear. An example is shown below. You will be asked to <b>choose one of these circles in order to earn points.</b></p>" +
        dm_example_html[0],
      '<p style="text-align:left;">The number of points that you could win, and your chances of winning those points, depends on the circle that you choose.<br><br>The number of points that you could win is determined by the <b>thickness of the lines</b> inside the circle.<br><br>' +
        "If the lines inside the circle are <b>" +
        sf_instruction_str[dmBalance][0] +
        "</b>, choosing that circle could win you <b>more points</b><br><br>" +
        "If the lines inside the circle are <b>" +
        sf_instruction_str[dmBalance][1] +
        "</b>, choosing that circle could win you <b>fewer points</b><br><br>The picture below shows some examples of thicknesses you will see in the task, and the points they correspond to:</p>" +
        sf_example_html,
      "<p style='text-align:left;'>For example, in the picture below, picking the <b>" +
        "left" +
        "</b> circle could win the <b>most points</b>, picking the <b>" +
        "right" +
        "</b> circle could win the <b>least points</b>, and picking the <b>" +
        "top" +
        "</b> circle could win a <b>medium number of points</b>.</p>" +
        dm_example_html[1],
      '<p style="text-align:left;">However, you will not always win the points associated with your chosen circle. The chance of winning the reward is determined by the <b>orientation of the lines</b> inside the circle.<br><br>' +
        "The closer the lines are to <b>" +
        orientation_instruction_str[dmBalance][0] +
        "</b>, the <b>higher the chance</b> that you will win points if you choose that circle.<br><br>" +
        "The closer the lines are to <b>" +
        orientation_instruction_str[dmBalance][1] +
        "</b>, the <b>lower the chance</b> that you will win points if you choose that circle.<br><br>The picture below shows some examples of orientations you will see in the task, and the percent chance of winning that they correspond to:</p>" +
        orientation_example_html,
      "<p style='text-align:left;'>For example, in the picture below, picking the <b>" +
        "right" +
        "</b> circle would give you the <b>highest chance of winning</b>, picking the <b>" +
        "left" +
        "</b> circle would give you the <b>lowest chance of winning</b>, and picking the <b>" +
        "top" +
        "</b> circle would give you a <b>medium chance of winning</b>.</p>" +
        dm_example_html[2],
      "<p style='text-align:left;'>In the task, each circle's lines will have a different thickness AND a different orientation. You should take both into account when making your choice.<br><br>For example, in the picture below, picking the <b>" +
        "left" +
        "</b> circle would give you a <b>high chance</b> of winning a <b>large reward</b>. Picking the <b>" +
        "top" +
        "</b> circle would give you a <b>medium chance</b> of winning a <b>medium reward</b>. Picking the <b>" +
        "right" +
        "</b> circle would give you a <b>low chance</b> of winning a <b>low reward</b>.</p>" +
        dm_example_html[3],
      "<p style='text-align:left;'>In this picture, picking the <b>" +
        "left" +
        "</b> circle would give you a <b>high chance</b> of winning a <b>small reward</b>. Picking the <b>" +
        "top" +
        "</b> circle would give you a <b>medium chance</b> of winning a <b>medium reward</b>. Picking the <b>" +
        "right" +
        "</b> circle would give you a <b>low chance</b> of winning a <b>large reward</b>.</p>" +
        dm_example_html[4],
      "<p style='text-align:left;'>And in this picture, picking the <b>" +
        "right" +
        "</b> circle would give you a <b>high chance</b> of winning a <b>medium reward</b>. Picking the <b>" +
        "top" +
        "</b> circle would give you a <b>medium chance</b> of winning a <b>large reward</b>. Picking the <b>" +
        "left" +
        "</b> circle would give you a <b>low chance</b> of winning a <b>small reward</b>.</p>" +
        dm_example_html[5],
      "<p style='text-align:left;'>One of the circles will be coloured on each trial. However, <b>colour does not mean anything</b> in this part of the experiment, so you should ignore the colour, and make your decision based on the lines inside the circles.</p>" +
        dm_example_html[0],
      "<p style='text-align:left;'>On each trial you will make your choice using the arrow keys on your keyboard.<br><br>" +
        "To pick the left circle, press the LEFT ARROW KEY. To pick the top circle, press the UP ARROW KEY. To pick the right circle, press the RIGHT ARROW KEY.</p>" +
        dm_example_html[0],
      "<p style='text-align:left;'>After you make your choice, you will be shown how many points you have earned. These points will add to your total number that you have collected so far and count towards your chance of winning a " +
        prizeStr +
        ".</p>",
      "<p style='text-align:left;'>You will only have " +
        dmTimeoutDuration +
        " ms to make your choice. If you do not make a choice within that time, then you will earn nothing for that trial. So make sure to choose quickly!</p>",
    ];

    numQs[3] = 5;

    Q_prompt[3][0] =
      "<b>What determines the size of the reward that you could win in this part of the experiment?</b>";
    Q_answer[3][0] = [
      " The thickness of the lines in the chosen circle",
      " The orientation of the lines in the chosen circle",
      " The colour of the chosen circle",
    ];

    Q_prompt[3][1] =
      "<b>What determines the chance of winning the reward in this part of the experiment?</b>";
    Q_answer[3][1] = [
      " The thickness of the lines in the chosen circle",
      " The orientation of the lines in the chosen circle",
      " The colour of the chosen circle",
    ];

    Q_prompt[3][2] =
      "<b>What does it mean if the lines inside a circle are " +
      sf_instruction_str[dmBalance][0] +
      "?</b>";
    Q_answer[3][2] = [
      " Choosing this circle could result in a larger reward",
      " Choosing this circle could result in a smaller reward",
      " Choosing this circle would give a high chance of winning a reward",
    ];

    Q_prompt[3][3] =
      "<b>What does it mean if the lines inside a circle are " +
      orientation_instruction_str[dmBalance][1] +
      "?</b>";

    Q_answer[3][3] = [
      " Choosing this circle would give a high chance of winning a reward",
      " Choosing this circle would give a low chance of winning a reward",
      " Choosing this circle could result in a larger reward",
    ];

    Q_prompt[3][4] =
      "<b>How would you choose the circle presented on the left side of the screen?</b>";

    Q_answer[3][4] = [" Press 'C'", " Press 'M'", " Press the LEFT ARROW KEY"];

    correctString[3] =
      '{"Q0":"' +
      Q_answer[3][0][0] +
      '","Q1":"' +
      Q_answer[3][1][1] +
      '","Q2":"' +
      Q_answer[3][2][0] +
      '","Q3":"' +
      Q_answer[3][3][1] +
      '","Q4":"' +
      Q_answer[3][4][2] +
      '"}';

    // ******************* INST SET 4 ******************
    instructStr[4] = [
      '<p style="text-align:left;">During the SEARCH TASK, the number of points that you could win on each trial was determined by the colour of the coloured circle in the display. When certain colours appeared, you could potentially win more points than when other colours appeared.<br><br>In the next phase we will test what you have learned about the different colours of circles.</p><br>',
      '<p style="text-align:left;">You will be shown two coloured circles, and will be asked to choose which one meant that the trial was a BONUS trial. If you are correct, we will add 1000 points to your total.</p><br>',
    ];

    numQs[4] = 2;

    Q_prompt[4][0] =
      "<b>What should you do on each trial of the next phase?</b>";
    Q_answer[4][0] = [
      " Choose the colour of circle randomly",
      " Choose the colour of circle that indicated the trial was a BONUS trial",
      " Choose the colour of circle that is brightest",
    ];

    Q_prompt[4][1] = "<b>What will happen after you make your choice?</b>";
    Q_answer[4][1] = [
      " I will earn no points",
      " If I am correct, I will earn 1000 points",
      " I will lose the number of points that I would have received in the search task for making an error",
    ];

    correctString[4] =
      '{"Q0":"' + Q_answer[4][0][1] + '","Q1":"' + Q_answer[4][1][1] + '"}';

    // ******************* INST SET 5 ******************
    instructStr[5] = [
      '<p style="text-align:left;">During the CHOICE TASK, the number of points that you could win was determined by the thickness of the lines inside the circle that you chose.</p><br>',
      '<p style="text-align:left;">In the next phase, you will be shown pictures of two different circles and will be asked to choose which one you think would earn more points in the choice task.<br><br>If you are correct, we will add 1000 points to your total.</p><br>',
    ];

    numQs[5] = 2;

    Q_prompt[5][0] =
      "<b>What should you do on each trial of the next phase?</b>";
    Q_answer[5][0] = [
      " Choose a circle randomly",
      " Choose the circle that would give more points in the choice task",
      " Choose the circle that is brightest",
    ];

    Q_prompt[5][1] = "<b>What will happen after you make your choice?</b>";
    Q_answer[5][1] = [
      " If I am correct, I will earn 1000 points",
      " I will earn no points",
      " I will lose 1000 points",
    ];

    correctString[5] =
      '{"Q0":"' + Q_answer[5][0][1] + '","Q1":"' + Q_answer[5][1][0] + '"}';

    // ******************* INST SET 6 ******************
    instructStr[6] = [
      '<p style="text-align:left;">During the CHOICE TASK, your chance of winning points was determined by the orientation of the lines inside the circle that you chose.</p><br>',
      '<p style="text-align:left;">In the next phase, you will be shown pictures of two different circles and will be asked to choose which one you think would give you the higher chance of winning points in the choice task.<br><br>If you are correct, we will add 1000 points to your total.</p><br>',
    ];

    numQs[6] = 2;

    Q_prompt[6][0] =
      "<b>What should you do on each trial of the next phase?</b>";
    Q_answer[6][0] = [
      " Choose the circle that would give you the highest chance of winning points in the choice task",
      " Choose a circle randomly",
      " Choose the circle that is brightest",
    ];

    Q_prompt[6][1] = "<b>What will happen after you make your choice?</b>";
    Q_answer[6][1] = [
      " I will earn no points",
      " I will lose 1000 points",
      " If I am correct, I will earn 1000 points",
    ];

    correctString[6] =
      '{"Q0":"' + Q_answer[6][0][0] + '","Q1":"' + Q_answer[6][1][2] + '"}';

    // ******************* SET UP INSTRUCTION LOOPS ******************

    var show_instructions = {
      type: "instructions",
      pages: function () {
        return instructStr[instSet];
      },
      show_clickable_nav: true,
      post_trial_gap: 0,
    };

    var instructions_repeat = true;

    var instructions_check = {
      type: "survey-multi-choice-mlp",
      preamble: [
        "<p style='text-align:center;'>Check your knowledge before you continue!</p>",
      ],
      questions: function () {
        var qItems = [];
        for (ii = 0; ii < numQs[instSet]; ii++) {
          qItems[ii] = {
            prompt: Q_prompt[instSet][ii],
            options: Q_answer[instSet][ii],
            required: true,
          };
        }
        return qItems;
      },
      post_trial_gap: 0,
      on_finish: function (data) {
        const diff = (diffMe, diffBy) => diffMe.split(diffBy).join("");
        const c = diff(data.responses, correctString[3]);
        if (data.responses == correctString[instSet]) {
          instructions_repeat = false;
        }
        jsPsych.data.addDataToLastTrial({
          instSet: instSet,
          instruct_qs: 1,
        });
      },
    };

    var instructions_check_failed_display = {
      type: "html-button-response",
      stimulus:
        "<p><b>Unfortunately, at least one of your answers was incorrect.</b></p>",
      choices: ["<p>Click here to read the instructions again</p>"],
      button_html:
        '<button class="fancyButtonRed" style="vertical-align:middle"><span>%choice%</span></button><br><br>',
      post_trial_gap: 100,
    };

    var instructions_check_failed_conditional = {
      timeline: [instructions_check_failed_display],
      conditional_function: function () {
        return instructions_repeat;
      }, // If this is true, it will execute timeline (show failure screen)
    };

    var ready_to_continue = {
      type: "html-keyboard-response-mlp",
      stimulus: function () {
        var successStr = "";
        if (instSet == 0) {
          successStr =
            "<p><b>Well done &ndash; all your answers were correct!</b></p><p>You'll now have a chance to practice the task.</p><p style='font-size:90%;'><br>Please place your fingers on the C and M keys<br>and press any key to begin</p>";
        } else if (instSet == 1 || instSet == 2) {
          successStr =
            "<p style='font-size:130%;'>You're now ready to start the main experiment. Good luck! </p><p style='font-size:90%;'><br>Please place your fingers on the C and M keys<br>and press any key to begin</p>";
        } else if (instSet == 3) {
          successStr =
            "<p><b>Well done &ndash; all your answers were correct!</b></p><p>You'll now have a chance to practice the choice task</p><p style='font-size:90%;'><br>Please place your fingers on the arrow keys<br>and press any key to begin</p>";
        } else if (instSet == 97) {
          successStr =
            "<p><b>Well done!</b></p><p>You're now ready to start making real choices. From now on, the points that you win will be added to your total. Good luck! </p><p style='font-size:90%;'><br>Please press any key to begin</p>";
        } else if (instSet == 98) {
          successStr =
            '<p>From now on, you will switch back and forth between the choice task and the search task. We will remind you which task you will be doing at the start of each block. In the next block, you will be doing the SEARCH TASK.</p><p>Remember: Your task is to search for the diamond. Press "C" if the lines inside the diamond are horizontal, and press "M" if the lines inside the diamond are vertical.</p><p style="font-size:90%;"><br>Please place your fingers on the C and M keys<br>and press either key to begin</p>';
        } else {
          successStr = "<p>Press any key to begin</p>";
        }
        return successStr;
      },
      choices: function () {
        if (instSet == 98) {
          return ["c", "m"];
        } else {
          return null;
        }
      },
    };

    var loop_instructions = {
      timeline: [
        show_instructions,
        instructions_check,
        instructions_check_failed_conditional,
      ],
      loop_function: function () {
        return instructions_repeat;
      }, // If instructions_repeat remains true, this will keep looping; if it becomes false, it will move on.
    };

    var query_supermarket = true;
    var get_email_for_prize = {
      type: "survey-text-mlp",
      preamble:
        '<p style="text-align:left;font-size:120%">Well done &ndash; all your answers were correct!<br><br><b>If you would like to be eligible to win ' +
        prizeStrShort +
        ', please enter your email below. If you win a prize we will send it to this address.</b></p><p style="text-align:left;font-size:100%">If you provide an email address it will not be passed to any third parties. Once the prizes have been awarded, we will delete your address from our records.<br><br>If you do not want to provide an email address then please leave the box blank. However if you do not provide an email, you will not be eligible to win a prize.</p>',
      questions: [
        {
          prompt: "<b>Email:</b>",
          placeholder: "Enter email here",
          rows: 1,
          columns: 35,
        },
      ],
      option_layout: "horizontal",
      post_trial_gap: 0,
      on_finish: function (data) {
        if (data.responses == '{"Q0":""}') {
          query_supermarket = false;
        }
      },
    };
    var select_supermarket = {
      type: "survey-multi-choice-mlp",
      preamble:
        '<p style="text-align:left;font-size:120%"><b>If you win a prize, which chain would you like the voucher to be for?</b></p>',
      questions: [
        { prompt: "", options: [" Coles", " Woolworths"], required: true },
      ],
      post_trial_gap: 0,
    };

    var conditional_supermarket = {
      timeline: [select_supermarket],
      conditional_function: function () {
        return query_supermarket;
      },
    };

    var get_prize_info = {
      timeline: [
        get_email_for_prize,
        conditional_supermarket,
        ready_to_continue,
      ],
    };

    var practice_instructions = {
      on_timeline_start: function () {
        instSet = 0;
        instructions_repeat = true;
      },
      timeline: [loop_instructions, ready_to_continue],
    };

    var main_instructions1 = {
      on_timeline_start: function () {
        instSet = 1;
        instructions_repeat = true;
      },
      timeline: [loop_instructions],
    };

    var main_instructions2 = {
      on_timeline_start: function () {
        instSet = 2;
        instructions_repeat = true;
      },
      timeline: [loop_instructions],
    };

    var dm_instructions1 = {
      on_timeline_start: function () {
        instSet = 3;
        instructions_repeat = true;
      },
      timeline: [loop_instructions],
    };

    var dm_instructions2 = {
      on_timeline_start: function () {
        instSet = 97;
      },
      timeline: [ready_to_continue],
    };

    var alternate_instructions = {
      on_timeline_start: function () {
        instSet = 98;
      },
      timeline: [ready_to_continue],
    };

    var search_test_instructions = {
      on_timeline_start: function () {
        instSet = 4;
        instructions_repeat = true;
      },
      timeline: [loop_instructions, ready_to_continue],
    };

    var choice_test_instructions1 = {
      on_timeline_start: function () {
        instSet = 5;
        instructions_repeat = true;
      },
      timeline: [loop_instructions, ready_to_continue],
    };

    var choice_test_instructions2 = {
      on_timeline_start: function () {
        instSet = 6;
        instructions_repeat = true;
      },
      timeline: [loop_instructions, ready_to_continue],
    };

    // ******************* CONSENT, DEMOGRAPHICS AND DEBRIEF ******************

    var studyName = "Visual search and choice";

    var piscf_info = {};

    piscf_info.task = {};
    piscf_info.task.time = "1 hour";
    piscf_info.task.credit = "1";

    piscf_info.ethics = {};
    piscf_info.ethics.approval = "3691";
    piscf_info.ethics.name = studyName;

    var mWidth = "10px 0px";

    var piscf = {
      type: "html-button-response",
      stimulus: function () {
        document.getElementById("jspsychTargetMLP").style.position = "static";
        document.getElementById("jspsychTargetMLP").style.height = "100%";
        document.getElementById("jspsychTargetMLP").style.width = "100%";
        document.getElementById("jspsychTargetMLP").style.top = "0%";
        document.getElementById("jspsychTargetMLP").style.left = "0%";
        document.getElementById("jspsychTargetMLP").style.margin = "0";

        if (realVersion == false) {
          console.log("pID: " + sona_id);
        }

        var sf = "90%";
        var lh = "150%";

        var htmlStr =
          '<p style="text-align:center;"><b>UNSW SYDNEY SCHOOL OF PSYCHOLOGY<br>' +
          "PARTICIPANT INFORMATION STATEMENT AND CONSENT FORM</b><br>" +
          piscf_info.ethics.name +
          "<br></p><p>Please read over the information below and click the button at the bottom of the page if you consent to participate in the study.</p>";

        htmlStr +=
          '<ol style="text-align:left;line-height:190%;margin:' +
          mWidth +
          ";font-size:" +
          sf +
          ";line-height:" +
          lh +
          ';">' +
          "<li> <p><b>What is the research study about?</b><br>You are invited to take part in this research study. The research study aims to investigate the attention in decision-making, by asking you to (1) search for shapes as quickly and accurately as possible, and (2) choose between different shapes. You have been invited because you registered to participate in this study via SONA, and your contact details were obtained from SONA.</p></li>" +
          "<li> <p><b>Who is conducting this research?</b><br>The study is being carried out by the following researchers: Professor Mike Le Pelley and Dr Daniel Pearson, School of Psychology, UNSW Sydney. <b><i>Research Funder:</b></i> This research is being funded by the Australian Research Council.</p></li>" +
          "<li> <p><b>Inclusion/Exclusion Criteria</b><br>Before you decide to participate in this research study, you should meet the following criterion: <b><i>Normal colour vision</b></i></p></li>" +
          "<li> <p><b>Do I have to take part in this research study?</b><br>Participation in this research study is voluntary. If you do not want to take part, you do not have to. If you decide to take part and later change your mind, you are free to withdraw from the study at any stage (See Item 11).</p></li>" +
          "<li> <p><b>What does participation in this research require, and are there any risks involved?</b><br>If you decide to take part in the research study, we will ask you to complete a search task, in which you will be asked to search for and respond to shapes. You will earn be able to earn points for making correct responses. Then, you will complete a choice task in which we will ask you to choose between different shapes in order to earn points. We don't expect this research to cause any harm. However, you may skip any or all written or verbal questions if you wish. Please let the researchers know if you need any assistance for any reason.</p></li>" +
          "<li> <p><b>Total participation time</b><br>In total, participation in this study will require " +
          piscf_info.task.time +
          ".</p></li>" +
          "<li> <p><b>Recompense to participants</b><br>You will receive " +
          piscf_info.task.credit +
          " SONA credit as recompense for your participation. In addition, you will be able to earn points during the study, and the 25% of participants who earn the most points will receive a bonus of " +
          prizeStr +
          ".<br></li>" +
          "<li> <p><b>What are the possible benefits to participation?</b><br>We cannot promise that you will receive any benefits from this study, but we hope to use the findings from this study to better understand the relationship between attention and decision-making.</p></li>" +
          "<li> <p><b>What will happen to information about me?</b><br>The information that you give us will be kept for 10 years after the project's completion. We will store information about you in a non-identifiable format at UNSW (Kensington Campus).<br>Researchers at UNSW are requested to store their aggregated research data in the UNSW data repository, this is a system called ResData. Once the aggregated data are deposited into this repository, they will be retained in this system permanently, but in a format where your data will not be individually identifiable.<br>Your non-identifiable information will be used in publications and reports based on this research study. Information collected for this research project may be made available to other research projects in de-identified form only.<br>If you provide your email address during the study, this information will be kept only until the $15 gift vouchers have been sent to the top 25&#37; of participants (which will occur within 3 months of data collection). After this time, email addresses will be irretrievably stripped from the data files to ensure your privacy, confidentiality and anonymity are preserved.</p></li>" +
          "<li> <p><b>How and when will I find out what the results of the research study are?</b><br>The research team intend to publish and/ report the results of the research study in a variety of ways. All information published will be done in a way that will not identify you. If you would like to receive a copy of the results you can let the research team know by emailing Prof Mike Le Pelley: m.lepelley@unsw.edu.au. We will only use these details to send you the results of the research.</p></li>" +
          "<li> <p><b>What if I want to withdraw from the research study?</b><br>If you do consent to participate, you may withdraw at any time. You do not have to give any reason for withdrawing. However, please let the researcher know by email. Your decision not to participate or to withdraw from the study will not affect your relationship with UNSW Sydney. If you decide to withdraw from the research study, the researchers will not collect additional information from you. Any identifiable information about you will be withdrawn from the research project.</p></li>" +
          '<li> <b>What should I do if I have further questions about my involvement in the research study?</b><br>If you require further information regarding this study or if you have any problems that may be related to your involvement in the study, you can contact the following member/s of the research team:<p class="conDets"><b><i>Research Team Contact Details</b></i><br><b>Chief Investigator:</b> Prof Mike Le Pelley<br><b>Position:</b> Professor<br><b>Telephone:</b> +61 2 9065 1458<br><b>Email:</b> m.lepelley@unsw.edu.au</p><p class="conDets"><b>Partner Investigator:</b> Dr Daniel Pearson<br><b>Position:</b> Research Associate<br><b>Email:</b> d.pearson@unsw.edu.au</p></li>' +
          '<li> <b>What if I have a complaint or any concerns about the research study?</b><br>If you have a complaint regarding any aspect of the study or the way it is being conducted, please contact the UNSW Human Ethics Coordinator:<p class="conDets"><b><i>Complaints Contact</b></i><br><b>Position:</b> UNSW Human Research Ethics Coordinator<br><b>Telephone:</b> +61 2 9385 6222<br><b>Email:</b> humanethics@unsw.edu.au<br><b>HC Reference Number:</b> ' +
          piscf_info.ethics.approval +
          "</span></p></li>" +
          "</ol>";

        return htmlStr;
      },
      choices: [
        '<p style="font-size:130%;line-height:0%;"><b>Please click here when you have read the above information</b></p>',
      ],
      button_html:
        '<button style="vertical-align:middle;line-height:150%"><span>%choice%</span></button><br><br>',
    };

    var consentDenied = true;

    var consent_form = {
      type: "html-button-response",
      stimulus: function () {
        document.getElementById("jspsychTargetMLP").style.position = "static";
        document.getElementById("jspsychTargetMLP").style.height = "100%";
        document.getElementById("jspsychTargetMLP").style.width = "100%";
        document.getElementById("jspsychTargetMLP").style.top = "0%";
        document.getElementById("jspsychTargetMLP").style.left = "0%";
        document.getElementById("jspsychTargetMLP").style.margin = "0";
        var sf = "90%";
        var lh = "150%";

        var htmlStr =
          '<h2 style="text-align:left;line-height:190%;margin:' +
          mWidth +
          ';">Consent form &ndash; Participant providing own consent</h2><p style="text-align:left;font-weight:bold;">Declaration by the participant</p>' +
          "<ul line-height:190%;margin:" +
          mWidth +
          ';"><li>I understand I am being asked to provide consent to participate in this research study.</li>' +
          "<li>I have read the Participant Information Sheet or someone has read it to me in a language that I understand.</li>" +
          "<li>I understand the purposes, study tasks and risks of the research described in the study.</li>" +
          "<li>I provide my consent for the information collected about me to be used for the purpose of this research study only.</li>" +
          "<li>I have been given contact details of the researchers to enable me to ask questions about my participation.</li>" +
          "<li>I freely agree to participate in this research study as described and understand that I am free to withdraw at any time during the study and withdrawal will not affect my relationship with any of the named organisations and/or research team members.</li></ul><br>" +
          "<p style='text-align:left'>If you wish to receive a copy of the results of this experiment, please email Prof. Mike Le Pelley at m.lepelley@unsw.edu.au</p>" +
          "<p><b>Please click on the appropriate button below.</b></p><br>";

        return htmlStr;
      },
      choices: [
        '<p style="font-size:130%;line-height:120%;"><b>I consent<br>to participate</b></p>',
        '<p style="font-size:130%;line-height:120%;"><b>I DO NOT consent<br>to participate</b></p>',
      ],
      button_html: [
        '<button class="consentButton" style="vertical-align:middle;width:200px;"><span>%choice%</span></button><br><br>',
        '<button class="noConsentButton" style="vertical-align:middle;width:200px;"><span>%choice%</span></button><br><br>',
      ],
      margin_horizontal: "50px",
      on_finish: function (data) {
        if (data.button_pressed == "0") {
          consentDenied = false;
          document.getElementById("jspsychTargetMLP").style.position =
            "absolute";
          document.getElementById("jspsychTargetMLP").style.width =
            winWidth + "px";
          document.getElementById("jspsychTargetMLP").style.marginLeft =
            -winWidth / 2 + "px";
          document.getElementById("jspsychTargetMLP").style.left = "50%";
          var today = new Date();
          var startTime =
            today.getFullYear() +
            "-" +
            pad(today.getMonth() + 1, 2) +
            "-" +
            pad(today.getDate(), 2) +
            "_" +
            pad(today.getHours(), 2) +
            ":" +
            pad(today.getMinutes(), 2) +
            ":" +
            pad(today.getSeconds(), 2);

          jsPsych.data.addDataToLastTrial({
            sonaID: sona_id,
            resultsID: resultsID,
            startTime: startTime,
          });

          if (jatosVersion == true) {
            // var result_for_JATOS = jsPsych.data.get().ignore(fieldsToIgnore).json();
            var result_for_JATOS = jsPsych.data
              .get()
              .ignore(fieldsToIgnore)
              .json();
            // .csv();
            jatos.submitResultData(result_for_JATOS);
          }
        }
      },
    };

    var no_consent_given = {
      type: "html-keyboard-response-mlp",
      stimulus:
        '<p style="text-align:centre;font-size:130%;line-height:160%;">You have chosen not to participate in this experiment.<br>It\'s now OK to close this window (please do not use the "back" button on your browser).<br><br><br></p>',
      choices: jsPsych.NO_KEYS,
    };

    var consent_conditional = {
      timeline: [no_consent_given],
      conditional_function: function () {
        return consentDenied;
      },
    };

    var run_consent_procedure = {
      timeline: [piscf, consent_form, consent_conditional],
    };

    var do_not_close_instructions = {
      type: "instructions",
      pages: [
        '<p style="text-align:left;font-size:120%"><b>Please complete this task in a quiet environment, with as few distractions as possible &ndash; please turn off your phone (or put it on silent).<br><br>Please do not close this window or use the "Back" button on your browser until you are told that the experiment is complete!</b><br><br></p>',
      ],
      show_clickable_nav: true,
      post_trial_gap: 0,
    };

    var demographics = {
      type: "demographic-response",
      stimulus:
        '<p style="text-align:left;font-size:120%">If you are happy to do so, please enter demographic information below.<br>You can leave an item blank if you would prefer not to say.<br><br></p>' +
        '<p style="text-align:left;">' +
        "<!-- Gender -->" +
        '<label for="gender"><b>Gender: &nbsp;</b></label>' +
        '<input type="radio" name="gender" value="male" /> Male &nbsp; ' +
        '<input type="radio" name="gender" value="female" /> Female &nbsp;' +
        '<input type="radio" name="gender" value="other" /> Other<br /><br />' +
        "<!-- Age -->" +
        '<label for="age"><b>Age: &nbsp;</b></label><input id="age" name="age" /><br /><br />' +
        "<!-- Language -->" +
        '<label for="language"><b>Native language(s): &nbsp;</b></label>' +
        '<input id="language" name="language" /><br /><br />',

      choices: ['<p style="font-size:130%;line-height:0%;"><b>Next ></b></p>'],

      on_finish: function (trial_data) {
        jsPsych.data.addDataToLastTrial({
          gender: p_gender,
          age: p_age,
          language: p_language,
        });
      },
    };

    var debrief = {
      type: "html-button-response",
      stimulus: function () {
        document.getElementById("jspsychTargetMLP").style.position = "static";
        document.getElementById("jspsychTargetMLP").style.height = "100%";
        document.getElementById("jspsychTargetMLP").style.width = "100%";
        document.getElementById("jspsychTargetMLP").style.top = "0%";
        document.getElementById("jspsychTargetMLP").style.left = "0%";
        document.getElementById("jspsychTargetMLP").style.margin = "0";

        var sf = "100%";
        var lh = "160%";

        var htmlStr =
          '<p style="text-align:left;font-size:120%;"><b>DEBRIEF</b></b><p style="text-align:left;font-size:' +
          sf +
          ";line-height:" +
          lh +
          ';">You earned ' +
          numberWithCommas(totalPoints) +
          " points in this task &ndash; well done! When we have finished collecting data for this study, if you are in the top 25% of participants you will receive " +
          prizeStrShort +
          ". We will send this prize to the email address that you entered earlier (if you did not enter an email address, you will not be eligible for the prize).<br><br>";
        htmlStr +=
          'In this study, we are investigating the factors that influence when people will be distracted, and how that influences the choices that we make. You may have found that sometimes, while you were searching for the diamond, you were distracted by the coloured shape presented I the display. In particular, we are interested in the effect of rewards on distraction: are people more likely to be distracted by a colour that signals relatively large rewards, or can people learn to prevent themselves from being distractor (and hence respond more quickly) when a large reward is at stake? <br><br>We are also interested in the effects of distraction on the choices that we make. If you are more likely to be distracted by the colour that signals relatively large rewards, does that change the way you make decisions in the choice task?<br><br>The experiment is now complete. Thanks for taking part! We realise that this is a long and somewhat taxing task, and we appreciate your participation.<br><br>We will send a copy of the answers to the "standard" debriefing questions to your email address.</p><br>';
        return htmlStr;
      },
      choices: [
        "Please click here to acknowledge that you have<br>received this debriefing information",
      ],
      button_html:
        '<button class="endTestButton" style="vertical-align:middle;font-size:120%;line-height:150%"><span>%choice%</span></button>',
      on_finish: function () {
        if (jatosVersion == true) {
          // var result_for_JATOS = jsPsych.data.get().ignore(fieldsToIgnore).json();
          var result_for_JATOS = jsPsych.data
            .get()
            .ignore(fieldsToIgnore)
            .json();
          // .csv();
          jatos.submitResultData(result_for_JATOS);
        }
      },
    };

    var completion_url = "";

    // ******************* FADES ******************

    var fadeToBlack;
    var fadeToWhite;
    var fadeStep = 2;
    var lightnessVal;

    var fadeDuration = (17 * 100) / fadeStep; // Assume 60 Hz refresh (so 17ms frame update)

    var fadeToBlackTrial = {
      type: "html-keyboard-response-mlp",
      stimulus: "",
      trial_duration: 1,
      response_ends_trial: false,
      post_trial_gap: fadeDuration + initialPauseDuration,
      on_finish: function () {
        lightnessVal = 100;
        requestAnimationFrame(fadeToBlackFn);
      },
    };

    var fadeToWhiteTrial = {
      type: "html-keyboard-response-mlp",
      stimulus: "",
      trial_duration: 1,
      response_ends_trial: false,
      post_trial_gap: fadeDuration,
      on_finish: function () {
        lightnessVal = 0;
        requestAnimationFrame(fadeToWhiteFn);
      },
    };

    var usingComputer = true;
    (function (a) {
      if (
        /(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(
          a
        ) ||
        /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(
          a.substr(0, 4)
        )
      )
        usingComputer = false;
    })(navigator.userAgent || navigator.vendor || window.opera);

    function detectMob() {
      const toMatch = [
        /Android/i,
        /webOS/i,
        /iPhone/i,
        /iPad/i,
        /iPod/i,
        /BlackBerry/i,
        /Windows Phone/i,
      ];
      return toMatch.some((toMatchItem) => {
        return navigator.userAgent.match(toMatchItem);
      });
    }
    var usingMob = detectMob();
    if (usingMob == true) {
      usingComputer = false;
    }

    var using_mobile_device = {
      type: "instructions",
      pages: [
        '<p style="text-align:left;font-size:150%">You seem to be using a mobile device so you will not currently be able to complete this study.<br><br>To complete this study, please visit this website using a computer with a keyboard and mouse/trackpad.</p>',
      ],
    };

    // ******************* SET TIMELINE AND RUN EXPT ******************

    var exptTimeline = [];

    instSet = 0;

    if (usingComputer) {
      exptTimeline.push(preload_stimuli);
      exptTimeline.push(run_consent_procedure);
      exptTimeline.push(do_not_close_instructions);
      exptTimeline.push({
        type: "fullscreen",
        fullscreen_mode: true,
      });
      exptTimeline.push(demographics);
      exptTimeline.push(practice_instructions);
      exptTimeline.push(fadeToBlackTrial);
      exptTimeline.push(run_practice_phase);
      exptTimeline.push(fadeToWhiteTrial);
      exptTimeline.push(main_instructions1);
      exptTimeline.push(main_instructions2);
      exptTimeline.push(get_prize_info);
      exptTimeline.push(fadeToBlackTrial);
      exptTimeline.push(run_main_task);
      exptTimeline.push(fadeToWhiteTrial);
      exptTimeline.push(dm_instructions1);
      exptTimeline.push(fadeToBlackTrial);
      exptTimeline.push(run_dm_practice_phase);
      exptTimeline.push(fadeToWhiteTrial);
      exptTimeline.push(dm_instructions2);
      exptTimeline.push(fadeToBlackTrial);
      exptTimeline.push(run_dm_task_miniblock);
      exptTimeline.push(fadeToWhiteTrial);
      exptTimeline.push(alternate_instructions);
      exptTimeline.push(fadeToBlackTrial);
      for (ii = 0; ii < numMiniBlocks; ii++) {
        exptTimeline.push(run_search_task_miniblock);
        exptTimeline.push(run_dm_task_miniblock);
      }
      exptTimeline.push(fadeToWhiteTrial);
      exptTimeline.push(search_test_instructions);
      exptTimeline.push(fadeToBlackTrial);
      exptTimeline.push(run_searchTestTrials);
      exptTimeline.push(fadeToWhiteTrial);
      exptTimeline.push(choice_test_instructions1);
      exptTimeline.push(fadeToBlackTrial);
      exptTimeline.push(run_choiceTestTrials1);
      exptTimeline.push(fadeToWhiteTrial);
      exptTimeline.push(choice_test_instructions2);
      exptTimeline.push(fadeToBlackTrial);
      exptTimeline.push(run_choiceTestTrials2);
      exptTimeline.push(fadeToWhiteTrial);
      exptTimeline.push(expt_finished_questions);
      exptTimeline.push({
        type: "fullscreen",
        fullscreen_mode: false,
      });
      exptTimeline.push(debrief);
    } else {
      exptTimeline.push(using_mobile_device);
    }

    if (jatosVersion == true) {
      jatos.onLoad(function () {
        if (sonaVersion == true) {
          sona_id = jatos.urlQueryParameters.pID;
        }
        var finish_url_base = jatos.studyJsonInput.finish_url_base;
        var completion_url = finish_url_base + sona_id; // CHANGE THIS WHEN YOU HAVE THE CORRECT SONA URL
        var finish_msg =
          "The experiment is now complete &ndash; thanks for taking part!<br>We appreciate the time you've taken.<br><br><b>Please <a href=\"" +
          completion_url +
          '">click here</a> to be returned to Sona and receive your credit.</b><br><br><br></p>';
        jsPsych.init({
          timeline: exptTimeline,
          preload_images: imageFilenames,
          display_element: jspsychTargetMLP,
          show_preload_progress_bar: false,
          on_finish: function () {
            document.write(
              '<div id="endscreen" class="endscreen" style="width:100%"><div class="endscreen" style="text-align:center; font-family:Segoe UI, Arial, sans-serif; font-size:130%;line-height:160%;margin:0 auto"><p><br><br><br>' +
                finish_msg +
                "</p></div></div>"
            );
          },
        });
      });
    } else {
      jsPsych.init({
        timeline: exptTimeline,
        preload_images: imageFilenames,
        display_element: jspsychTargetMLP,
        show_preload_progress_bar: false, // hide preload progress bar
      });
    }

    // ******************* FUNCTIONS ******************

    function fadeToBlackFn() {
      lightnessVal -= fadeStep;
      if (lightnessVal <= 0) {
        lightnessVal = 0;
        document.getElementById("jspsychTargetMLP").style.color = "white";
      }
      document.body.style.backgroundColor = "hsl(0,0%," + lightnessVal + "%)";
      if (lightnessVal > 0) {
        requestAnimationFrame(fadeToBlackFn);
      }
    }

    function fadeToWhiteFn() {
      lightnessVal += fadeStep;
      if (lightnessVal >= 100) {
        lightnessVal = 100;
        document.getElementById("jspsychTargetMLP").style.color = "black";
      }
      document.body.style.backgroundColor = "hsl(0,0%," + lightnessVal + "%)";
      if (lightnessVal < 100) {
        requestAnimationFrame(fadeToWhiteFn);
      }
    }

    function shuffleArray(myArray) {
      var randNum, tempStore, j;
      for (j = myArray.length; j; j--) {
        randNum = Math.floor(Math.random() * j);
        tempStore = myArray[j - 1];
        myArray[j - 1] = myArray[randNum];
        myArray[randNum] = tempStore;
      }
    }

    function shuffleNewArray(myArray) {
      var randNum, tempStore, j;
      var copy = [].concat(myArray);
      for (j = myArray.length; j; j--) {
        randNum = Math.floor(Math.random() * j);
        tempStore = copy[j - 1];
        copy[j - 1] = copy[randNum];
        copy[randNum] = tempStore;
      }

      return copy;
    }

    function numberWithCommas(x) {
      return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function pad(n, len) {
      s = n.toString();
      if (s.length < len) {
        s = ("000" + s).slice(-len);
      }
      return s;
    }

    function checkForDuplicates(array) {
      return new Set(array).size !== array.length;
    }

    function generateDMTrials(
      num_colours,
      num_trial_types,
      num_trials_per_trial_type,
      dmDominance
    ) {
      var tempProbsIdx = [];
      var tempProbs = [];
      var tempValIdx = [];
      var tempVals = [];
      var tempEVs = [];
      var tempEVsSorted = [];
      var tempRanks = [];
      var tempCount = 0;
      var duplicateRank;
      for (dt = 0; dt < num_colours; dt++) {
        for (dmt = 0; dmt < num_trial_types; dmt++)
          for (dmTrials = 0; dmTrials < num_trials_per_trial_type; dmTrials++) {
            dmColourType[tempCount] = dt;
            dmTrialType[tempCount] = dmt;
            dmDominanceType[tempCount] = dmDominance[dmTrials];
            duplicateRank = true;
            duplicateVal = true;
            duplicateProbs = true;
            incorrectDominance = true;
            while (
              duplicateRank |
              duplicateVal |
              duplicateProbs |
              incorrectDominance
            ) {
              for (ss = 0; ss < 3; ss++) {
                tempValIdx[ss] = Math.floor(Math.random() * possValues.length);
                tempVals[ss] = possValues[tempValIdx[ss]];
                tempProbsIdx[ss] = Math.floor(
                  Math.random() * possProbabilities.length
                );
                tempProbs[ss] = possProbabilities[tempProbsIdx[ss]];
                tempEVs[ss] = tempVals[ss] * tempProbs[ss];
              }

              // get ranking of EVs
              tempEVsSorted = tempEVs.slice().sort((a, b) => b - a);
              // console.log(tempEVsSorted);
              tempRanks = tempEVsSorted.map((v) => tempEVs.indexOf(v));
              duplicateRank = checkForDuplicates(tempRanks); // check if there is a duplicate in ranks, means that two options have same EV
              duplicateVal = checkForDuplicates(tempVals); // check if there is a duplicate in values
              duplicateProbs = checkForDuplicates(tempProbs); // check if there is a duplicate in probabilities

              if (
                (tempVals[tempRanks[0]] == Math.max(...tempVals)) &
                (tempProbs[tempRanks[0]] == Math.max(...tempProbs))
              ) {
                tempDominantTrial = 1;
              } else {
                tempDominantTrial = 0;
              }

              if (dmDominanceType[tempCount] == tempDominantTrial) {
                incorrectDominance = false;
              }
            }

            switch (dmt) {
              case 0: // coloured option is best available
                dmTrialValue[tempCount] = [];
                dmTrialValue[tempCount][0] = tempVals[tempRanks[0]];
                dmTrialValue[tempCount][1] = tempVals[tempRanks[1]];
                dmTrialValue[tempCount][2] = tempVals[tempRanks[2]];

                dmTrialValueIdx[tempCount] = [];
                dmTrialValueIdx[tempCount][0] = tempValIdx[tempRanks[0]];
                dmTrialValueIdx[tempCount][1] = tempValIdx[tempRanks[1]];
                dmTrialValueIdx[tempCount][2] = tempValIdx[tempRanks[2]];

                dmTrialProbability[tempCount] = [];
                dmTrialProbability[tempCount][0] = tempProbs[tempRanks[0]];
                dmTrialProbability[tempCount][1] = tempProbs[tempRanks[1]];
                dmTrialProbability[tempCount][2] = tempProbs[tempRanks[2]];

                dmTrialProbIdx[tempCount] = [];
                dmTrialProbIdx[tempCount][0] = tempProbsIdx[tempRanks[0]];
                dmTrialProbIdx[tempCount][1] = tempProbsIdx[tempRanks[1]];
                dmTrialProbIdx[tempCount][2] = tempProbsIdx[tempRanks[2]];

                dmTrialEV[tempCount] = [];
                dmTrialEV[tempCount][0] = tempEVs[tempRanks[0]];
                dmTrialEV[tempCount][1] = tempEVs[tempRanks[1]];
                dmTrialEV[tempCount][2] = tempEVs[tempRanks[2]];
                break;
              case 1: // coloured option is medium value
                dmTrialValue[tempCount] = [];
                dmTrialValue[tempCount][0] = tempVals[tempRanks[1]];
                dmTrialValue[tempCount][1] = tempVals[tempRanks[0]];
                dmTrialValue[tempCount][2] = tempVals[tempRanks[2]];

                dmTrialValueIdx[tempCount] = [];
                dmTrialValueIdx[tempCount][0] = tempValIdx[tempRanks[1]];
                dmTrialValueIdx[tempCount][1] = tempValIdx[tempRanks[0]];
                dmTrialValueIdx[tempCount][2] = tempValIdx[tempRanks[2]];

                dmTrialProbability[tempCount] = [];
                dmTrialProbability[tempCount][0] = tempProbs[tempRanks[1]];
                dmTrialProbability[tempCount][1] = tempProbs[tempRanks[0]];
                dmTrialProbability[tempCount][2] = tempProbs[tempRanks[2]];

                dmTrialProbIdx[tempCount] = [];
                dmTrialProbIdx[tempCount][0] = tempProbsIdx[tempRanks[1]];
                dmTrialProbIdx[tempCount][1] = tempProbsIdx[tempRanks[0]];
                dmTrialProbIdx[tempCount][2] = tempProbsIdx[tempRanks[2]];

                dmTrialEV[tempCount] = [];
                dmTrialEV[tempCount][0] = tempEVs[tempRanks[1]];
                dmTrialEV[tempCount][1] = tempEVs[tempRanks[0]];
                dmTrialEV[tempCount][2] = tempEVs[tempRanks[2]];
                break;
              case 2: // coloured option is lowest value
                dmTrialValue[tempCount] = [];
                dmTrialValue[tempCount][0] = tempVals[tempRanks[2]];
                dmTrialValue[tempCount][1] = tempVals[tempRanks[0]];
                dmTrialValue[tempCount][2] = tempVals[tempRanks[1]];

                dmTrialValueIdx[tempCount] = [];
                dmTrialValueIdx[tempCount][0] = tempValIdx[tempRanks[2]];
                dmTrialValueIdx[tempCount][1] = tempValIdx[tempRanks[0]];
                dmTrialValueIdx[tempCount][2] = tempValIdx[tempRanks[1]];

                dmTrialProbability[tempCount] = [];
                dmTrialProbability[tempCount][0] = tempProbs[tempRanks[2]];
                dmTrialProbability[tempCount][1] = tempProbs[tempRanks[0]];
                dmTrialProbability[tempCount][2] = tempProbs[tempRanks[1]];

                dmTrialProbIdx[tempCount] = [];
                dmTrialProbIdx[tempCount][0] = tempProbsIdx[tempRanks[2]];
                dmTrialProbIdx[tempCount][1] = tempProbsIdx[tempRanks[0]];
                dmTrialProbIdx[tempCount][2] = tempProbsIdx[tempRanks[1]];

                dmTrialEV[tempCount] = [];
                dmTrialEV[tempCount][0] = tempEVs[tempRanks[2]];
                dmTrialEV[tempCount][1] = tempEVs[tempRanks[0]];
                dmTrialEV[tempCount][2] = tempEVs[tempRanks[1]];
                break;
            }
            tempCount++;
          }
      }
    }
  </script>
</html>
